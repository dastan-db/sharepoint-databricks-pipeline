<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SharePoint to Databricks Data Pipeline</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
            font-size: 0.9rem;
        }

        input {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
        }

        .btn-danger {
            background: #f56565;
            color: white;
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .config-list {
            margin-top: 20px;
        }

        .config-item {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .config-info {
            flex: 1;
        }

        .config-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .config-details {
            color: #718096;
            font-size: 0.9rem;
        }

        .config-actions {
            display: flex;
            gap: 10px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .alert-error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        .alert-info {
            background: #bee3f8;
            color: #2c5282;
            border: 1px solid #90cdf4;
        }

        .hidden {
            display: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä SharePoint to Databricks Data Pipeline</h1>

        <!-- Alert Messages -->
        <div id="alertContainer"></div>

        <!-- SharePoint Connections -->
        <div class="card">
            <h2>SharePoint Connections</h2>
            <form id="sharepointConnectionForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="spConnectionId">Connection ID *</label>
                        <input type="text" id="spConnectionId" required placeholder="e.g., sharepoint_main">
                    </div>
                    <div class="form-group">
                        <label for="spConnectionName">Connection Name *</label>
                        <input type="text" id="spConnectionName" required placeholder="e.g., Main SharePoint">
                    </div>
                    <div class="form-group">
                        <label for="spClientId">Client ID *</label>
                        <input type="text" id="spClientId" required placeholder="Azure Entra ID Client ID">
                    </div>
                    <div class="form-group">
                        <label for="spClientSecret">Client Secret *</label>
                        <input type="password" id="spClientSecret" required placeholder="Azure Client Secret">
                    </div>
                    <div class="form-group">
                        <label for="spTenantId">Tenant ID *</label>
                        <input type="text" id="spTenantId" required placeholder="Azure Tenant ID">
                    </div>
                    <div class="form-group">
                        <label for="spRefreshToken">Refresh Token *</label>
                        <input type="password" id="spRefreshToken" required placeholder="OAuth Refresh Token">
                    </div>
                    <div class="form-group">
                        <label for="spSiteId">SharePoint Site ID *</label>
                        <input type="text" id="spSiteId" required placeholder="SharePoint Site ID">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">
                    <span id="createSpConnectionBtnText">Create Connection</span>
                    <span id="createSpConnectionBtnLoading" class="loading hidden"></span>
                </button>
            </form>

            <div id="sharepointConnectionList" class="config-list" style="margin-top: 20px;">
                <div class="empty-state">
                    <p>No SharePoint connections yet. Create one above to get started!</p>
                </div>
            </div>
        </div>

        <!-- Lakeflow Pipelines (Excel Ingestion to Lakebase) -->
        <div class="card">
            <h2>Lakeflow Pipelines - Excel Ingestion to Lakebase</h2>
            <p style="color: #666; margin-bottom: 15px; font-size: 0.9rem;">Ingest Excel files from SharePoint into Lakebase documents table</p>
            <form id="sharepointPipelineForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="spPipelineId">Pipeline ID *</label>
                        <input type="text" id="spPipelineId" required placeholder="e.g., hr_excel_ingestion">
                    </div>
                    <div class="form-group">
                        <label for="spPipelineName">Pipeline Name *</label>
                        <input type="text" id="spPipelineName" required placeholder="e.g., HR Excel Ingestion">
                    </div>
                    <div class="form-group">
                        <label for="spConnectionSelect">SharePoint Connection *</label>
                        <select id="spConnectionSelect" required style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                            <option value="">Select a connection...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="spIngestionType">Ingestion Type *</label>
                        <select id="spIngestionType" required style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                            <option value="all_drives">All Drives (entire site)</option>
                            <option value="specific_drives">Specific Drives</option>
                        </select>
                    </div>
                    <div class="form-group" id="spDriveNamesGroup" style="display: none;">
                        <label for="spDriveNames">Drive Names (comma-separated)</label>
                        <input type="text" id="spDriveNames" placeholder="e.g., Documents, Shared Documents">
                    </div>
                    <div class="form-group">
                        <label for="spLakebaseTable">Lakebase Table *</label>
                        <input type="text" id="spLakebaseTable" required placeholder="e.g., documents" value="documents">
                    </div>
                    <div class="form-group">
                        <label for="spFilePattern">File Pattern</label>
                        <input type="text" id="spFilePattern" placeholder="e.g., *.xlsx" value="*.xlsx">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">
                    <span id="createSpPipelineBtnText">Create Pipeline</span>
                    <span id="createSpPipelineBtnLoading" class="loading hidden"></span>
                </button>
            </form>

            <div id="sharepointPipelineList" class="config-list" style="margin-top: 20px;">
                <div class="empty-state">
                    <p>No Lakeflow pipelines yet. Create one above to get started!</p>
                </div>
            </div>
        </div>

        <!-- Excel Streaming Configurations -->
        <div class="card">
            <h2>Excel Streaming Configurations</h2>
            <p style="color: #666; margin-bottom: 15px; font-size: 0.9rem;">Continuously stream Excel data from Lakebase to Delta tables</p>
            <form id="excelStreamForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="esConfigId">Config ID *</label>
                        <input type="text" id="esConfigId" required placeholder="e.g., hr_stream">
                    </div>
                    <div class="form-group">
                        <label for="esConfigName">Config Name *</label>
                        <input type="text" id="esConfigName" required placeholder="e.g., HR Data Stream">
                    </div>
                    <div class="form-group">
                        <label for="esLakebaseTable">Lakebase Table (Source) *</label>
                        <input type="text" id="esLakebaseTable" required placeholder="e.g., documents" value="documents">
                    </div>
                    <div class="form-group">
                        <label for="esFilePattern">File Name Pattern *</label>
                        <input type="text" id="esFilePattern" required placeholder="e.g., supplier_*.xlsx">
                    </div>
                    <div class="form-group">
                        <label for="esDestCatalog">Destination Catalog *</label>
                        <input type="text" id="esDestCatalog" required placeholder="e.g., main" value="main">
                    </div>
                    <div class="form-group">
                        <label for="esDestSchema">Destination Schema *</label>
                        <input type="text" id="esDestSchema" required placeholder="e.g., analytics">
                    </div>
                    <div class="form-group">
                        <label for="esDestTable">Destination Table *</label>
                        <input type="text" id="esDestTable" required placeholder="e.g., supplier_data">
                    </div>
                    <div class="form-group">
                        <label for="esCheckpointLocation">Checkpoint Location *</label>
                        <input type="text" id="esCheckpointLocation" required placeholder="/checkpoints/supplier_stream">
                    </div>
                    <div class="form-group">
                        <label for="esTriggerInterval">Trigger Interval</label>
                        <select id="esTriggerInterval" style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                            <option value="10 seconds">10 seconds</option>
                            <option value="30 seconds">30 seconds</option>
                            <option value="1 minute">1 minute</option>
                            <option value="5 minutes">5 minutes</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">
                    <span id="createEsBtnText">Create Stream Config</span>
                    <span id="createEsBtnLoading" class="loading hidden"></span>
                </button>
            </form>

            <div id="excelStreamList" class="config-list" style="margin-top: 20px;">
                <div class="empty-state">
                    <p>No Excel streaming configs yet. Create one above to get started!</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // API Communication Functions
        // ============================================
        
        const API_BASE = '';

        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(API_BASE + url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers,
                    },
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.message || 'API request failed');
                }
                return data;
            } catch (error) {
                throw error;
            }
        }

        // ============================================
        // UI Helper Functions
        // ============================================

        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function setLoading(btnTextId, btnLoadingId, isLoading) {
            const text = document.getElementById(btnTextId);
            const loading = document.getElementById(btnLoadingId);
            if (isLoading) {
                text.classList.add('hidden');
                loading.classList.remove('hidden');
            } else {
                text.classList.remove('hidden');
                loading.classList.add('hidden');
            }
        }

        // ============================================
        // SharePoint Connection Management
        // ============================================

        async function loadSharePointConnections() {
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/5e63e9c0-b95b-4914-9005-a6dcb88fa364',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:448',message:'loadSharePointConnections called',data:{},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'H3,H5'})}).catch(()=>{});
            // #endregion
            try {
                const connections = await apiCall('/sharepoint/connections');
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/5e63e9c0-b95b-4914-9005-a6dcb88fa364',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:449',message:'loadSharePointConnections success',data:{count:connections.length},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'H1,H3'})}).catch(()=>{});
                // #endregion
                renderSharePointConnections(connections);
                populateConnectionDropdown(connections);
            } catch (error) {
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/5e63e9c0-b95b-4914-9005-a6dcb88fa364',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:454',message:'loadSharePointConnections error',data:{error:error.message},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'H1,H2,H5'})}).catch(()=>{});
                // #endregion
                console.error('Failed to load SharePoint connections:', error);
                showAlert('Failed to load SharePoint connections: ' + error.message, 'error');
            }
        }

        function renderSharePointConnections(connections) {
            const connectionList = document.getElementById('sharepointConnectionList');
            
            if (!connections || connections.length === 0) {
                connectionList.innerHTML = `
                    <div class="empty-state">
                        <p>No SharePoint connections yet. Create one above to get started!</p>
                    </div>
                `;
                return;
            }

            connectionList.innerHTML = connections.map(conn => `
                <div class="config-item">
                    <div class="config-info">
                        <div class="config-title">${conn.name}</div>
                        <div class="config-details">
                            üîë ${conn.id} | üåê Site: ${conn.site_id}
                        </div>
                    </div>
                    <div class="config-actions">
                        <button class="btn btn-success" onclick="testSharePointConnection('${conn.id}')">
                            Test
                        </button>
                        <button class="btn btn-danger" onclick="deleteSharePointConnection('${conn.id}')">
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function populateConnectionDropdown(connections) {
            const select = document.getElementById('spConnectionSelect');
            select.innerHTML = '<option value="">Select a connection...</option>' +
                connections.map(conn => `<option value="${conn.id}">${conn.name}</option>`).join('');
        }

        async function createSharePointConnection(connectionData) {
            try {
                setLoading('createSpConnectionBtnText', 'createSpConnectionBtnLoading', true);
                await apiCall('/sharepoint/connections', {
                    method: 'POST',
                    body: JSON.stringify(connectionData),
                });
                showAlert('SharePoint connection created successfully!', 'success');
                document.getElementById('sharepointConnectionForm').reset();
                await loadSharePointConnections();
            } catch (error) {
                showAlert('Failed to create connection: ' + error.message, 'error');
            } finally {
                setLoading('createSpConnectionBtnText', 'createSpConnectionBtnLoading', false);
            }
        }

        async function testSharePointConnection(connectionId) {
            try {
                showAlert(`Testing connection ${connectionId}...`, 'info');
                const result = await apiCall(`/sharepoint/connections/${connectionId}/test`, {
                    method: 'POST',
                });
                
                if (result.success) {
                    showAlert(result.message, 'success');
                } else {
                    showAlert(result.message, 'error');
                }
            } catch (error) {
                showAlert('Failed to test connection: ' + error.message, 'error');
            }
        }

        async function deleteSharePointConnection(connectionId) {
            if (!confirm(`Are you sure you want to delete connection "${connectionId}"?`)) {
                return;
            }
            
            try {
                await apiCall(`/sharepoint/connections/${connectionId}`, {
                    method: 'DELETE',
                });
                showAlert('Connection deleted successfully!', 'success');
                await loadSharePointConnections();
            } catch (error) {
                showAlert('Failed to delete connection: ' + error.message, 'error');
            }
        }

        // ============================================
        // SharePoint Pipeline Management
        // ============================================

        async function loadSharePointPipelines() {
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/5e63e9c0-b95b-4914-9005-a6dcb88fa364',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:654',message:'loadSharePointPipelines called',data:{},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'H3,H5'})}).catch(()=>{});
            // #endregion
            try {
                const pipelines = await apiCall('/sharepoint/pipelines');
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/5e63e9c0-b95b-4914-9005-a6dcb88fa364',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:655',message:'loadSharePointPipelines success',data:{count:pipelines.length},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'H1,H3'})}).catch(()=>{});
                // #endregion
                renderSharePointPipelines(pipelines);
            } catch (error) {
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/5e63e9c0-b95b-4914-9005-a6dcb88fa364',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:660',message:'loadSharePointPipelines error',data:{error:error.message},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'H1,H2,H5'})}).catch(()=>{});
                // #endregion
                console.error('Failed to load SharePoint pipelines:', error);
                showAlert('Failed to load SharePoint pipelines: ' + error.message, 'error');
            }
        }

        function renderSharePointPipelines(pipelines) {
            const pipelineList = document.getElementById('sharepointPipelineList');
            
            if (!pipelines || pipelines.length === 0) {
                pipelineList.innerHTML = `
                    <div class="empty-state">
                        <p>No Lakeflow pipelines yet. Create one above to get started!</p>
                    </div>
                `;
                return;
            }

            pipelineList.innerHTML = pipelines.map(pipeline => `
                <div class="config-item">
                    <div class="config-info">
                        <div class="config-title">${pipeline.name}</div>
                        <div class="config-details">
                            üì¶ ${pipeline.ingestion_type === 'all_drives' ? 'All Drives' : 'Specific Drives'} ‚Üí 
                            üìä Lakebase: ${pipeline.lakebase_table} (${pipeline.file_pattern || '*.xlsx'})
                        </div>
                    </div>
                    <div class="config-actions">
                        <button class="btn btn-success" onclick="runSharePointPipeline('${pipeline.id}')">
                            Run
                        </button>
                        <button class="btn btn-primary" onclick="getSharePointPipelineStatus('${pipeline.id}')" style="background: #4299e1;">
                            Status
                        </button>
                        <button class="btn btn-danger" onclick="deleteSharePointPipeline('${pipeline.id}')">
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function createSharePointPipeline(pipelineData) {
            try {
                setLoading('createSpPipelineBtnText', 'createSpPipelineBtnLoading', true);
                await apiCall('/sharepoint/pipelines', {
                    method: 'POST',
                    body: JSON.stringify(pipelineData),
                });
                showAlert('Lakeflow pipeline created successfully!', 'success');
                document.getElementById('sharepointPipelineForm').reset();
                document.getElementById('spLakebaseTable').value = 'documents';
                document.getElementById('spFilePattern').value = '*.xlsx';
                await loadSharePointPipelines();
            } catch (error) {
                showAlert('Failed to create pipeline: ' + error.message, 'error');
            } finally {
                setLoading('createSpPipelineBtnText', 'createSpPipelineBtnLoading', false);
            }
        }

        async function runSharePointPipeline(pipelineId) {
            try {
                showAlert(`Starting pipeline ${pipelineId}...`, 'info');
                const result = await apiCall(`/sharepoint/pipelines/${pipelineId}/run`, {
                    method: 'POST',
                });
                
                if (result.success) {
                    showAlert(`Pipeline run started! Update ID: ${result.update_id}`, 'success');
                } else {
                    showAlert(result.message, 'error');
                }
            } catch (error) {
                showAlert('Failed to run pipeline: ' + error.message, 'error');
            }
        }

        async function getSharePointPipelineStatus(pipelineId) {
            try {
                const result = await apiCall(`/sharepoint/pipelines/${pipelineId}/status`);
                
                if (result.success) {
                    const statusMsg = `Pipeline State: ${result.state}\n` +
                        (result.latest_update ? 
                            `Latest Update: ${result.latest_update.state || 'N/A'}\n` +
                            `Update ID: ${result.latest_update.update_id || 'N/A'}` 
                            : 'No updates yet');
                    alert(statusMsg);
                } else {
                    showAlert(result.message, 'error');
                }
            } catch (error) {
                showAlert('Failed to get pipeline status: ' + error.message, 'error');
            }
        }

        async function deleteSharePointPipeline(pipelineId) {
            if (!confirm(`Are you sure you want to delete pipeline "${pipelineId}"?`)) {
                return;
            }
            
            try {
                await apiCall(`/sharepoint/pipelines/${pipelineId}`, {
                    method: 'DELETE',
                });
                showAlert('Pipeline deleted successfully!', 'success');
                await loadSharePointPipelines();
            } catch (error) {
                showAlert('Failed to delete pipeline: ' + error.message, 'error');
            }
        }

        // ============================================
        // Excel Streaming Management
        // ============================================

        async function loadExcelStreamConfigs() {
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/5e63e9c0-b95b-4914-9005-a6dcb88fa364',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:771',message:'loadExcelStreamConfigs called',data:{},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'H3,H5'})}).catch(()=>{});
            // #endregion
            try {
                const configs = await apiCall('/excel-streaming/configs');
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/5e63e9c0-b95b-4914-9005-a6dcb88fa364',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:772',message:'loadExcelStreamConfigs success',data:{count:configs.length},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'H1,H3'})}).catch(()=>{});
                // #endregion
                renderExcelStreamConfigs(configs);
            } catch (error) {
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/5e63e9c0-b95b-4914-9005-a6dcb88fa364',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:777',message:'loadExcelStreamConfigs error',data:{error:error.message},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'H1,H2,H5'})}).catch(()=>{});
                // #endregion
                console.error('Failed to load Excel stream configs:', error);
                showAlert('Failed to load Excel stream configs: ' + error.message, 'error');
            }
        }

        function renderExcelStreamConfigs(configs) {
            const streamList = document.getElementById('excelStreamList');
            
            if (!configs || configs.length === 0) {
                streamList.innerHTML = `
                    <div class="empty-state">
                        <p>No Excel streaming configs yet. Create one above to get started!</p>
                    </div>
                `;
                return;
            }

            streamList.innerHTML = configs.map(config => `
                <div class="config-item">
                    <div class="config-info">
                        <div class="config-title">
                            ${config.is_active ? 'üü¢' : 'üî¥'} ${config.name}
                        </div>
                        <div class="config-details">
                            üìÅ ${config.lakebase_table} (${config.file_name_pattern}) ‚Üí 
                            üìä ${config.destination_catalog}.${config.destination_schema}.${config.destination_table}
                        </div>
                    </div>
                    <div class="config-actions">
                        ${config.is_active ? 
                            `<button class="btn btn-danger" onclick="stopExcelStream('${config.id}')">Stop</button>` :
                            `<button class="btn btn-success" onclick="startExcelStream('${config.id}')">Start</button>`
                        }
                        <button class="btn btn-primary" onclick="getExcelStreamStatus('${config.id}')" style="background: #4299e1;">
                            Status
                        </button>
                        <button class="btn btn-danger" onclick="deleteExcelStreamConfig('${config.id}')">
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function createExcelStreamConfig(configData) {
            try {
                setLoading('createEsBtnText', 'createEsBtnLoading', true);
                await apiCall('/excel-streaming/configs', {
                    method: 'POST',
                    body: JSON.stringify(configData),
                });
                showAlert('Excel stream config created successfully!', 'success');
                document.getElementById('excelStreamForm').reset();
                document.getElementById('esLakebaseTable').value = 'documents';
                document.getElementById('esDestCatalog').value = 'main';
                await loadExcelStreamConfigs();
            } catch (error) {
                showAlert('Failed to create stream config: ' + error.message, 'error');
            } finally {
                setLoading('createEsBtnText', 'createEsBtnLoading', false);
            }
        }

        async function startExcelStream(configId) {
            try {
                showAlert(`Starting stream ${configId}...`, 'info');
                const result = await apiCall(`/excel-streaming/configs/${configId}/start`, {
                    method: 'POST',
                });
                
                if (result.success) {
                    showAlert(`Stream started successfully!`, 'success');
                    await loadExcelStreamConfigs();
                } else {
                    showAlert(result.message, 'error');
                }
            } catch (error) {
                showAlert('Failed to start stream: ' + error.message, 'error');
            }
        }

        async function stopExcelStream(configId) {
            try {
                showAlert(`Stopping stream ${configId}...`, 'info');
                const result = await apiCall(`/excel-streaming/configs/${configId}/stop`, {
                    method: 'POST',
                });
                
                if (result.success) {
                    showAlert(`Stream stopped successfully!`, 'success');
                    await loadExcelStreamConfigs();
                } else {
                    showAlert(result.message, 'error');
                }
            } catch (error) {
                showAlert('Failed to stop stream: ' + error.message, 'error');
            }
        }

        async function getExcelStreamStatus(configId) {
            try {
                const result = await apiCall(`/excel-streaming/configs/${configId}/status`);
                
                if (result.success) {
                    const statusMsg = `Config: ${result.config_name}\n` +
                        `State: ${result.state}\n` +
                        `Active: ${result.is_active ? 'Yes' : 'No'}\n` +
                        `Destination: ${result.destination}`;
                    alert(statusMsg);
                } else {
                    showAlert(result.message, 'error');
                }
            } catch (error) {
                showAlert('Failed to get stream status: ' + error.message, 'error');
            }
        }

        async function deleteExcelStreamConfig(configId) {
            if (!confirm(`Are you sure you want to delete stream config "${configId}"?`)) {
                return;
            }
            
            try {
                await apiCall(`/excel-streaming/configs/${configId}`, {
                    method: 'DELETE',
                });
                showAlert('Stream config deleted successfully!', 'success');
                await loadExcelStreamConfigs();
            } catch (error) {
                showAlert('Failed to delete stream config: ' + error.message, 'error');
            }
        }

        // ============================================
        // Event Handlers
        // ============================================

        document.getElementById('sharepointConnectionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const connectionData = {
                id: document.getElementById('spConnectionId').value,
                name: document.getElementById('spConnectionName').value,
                client_id: document.getElementById('spClientId').value,
                client_secret: document.getElementById('spClientSecret').value,
                tenant_id: document.getElementById('spTenantId').value,
                refresh_token: document.getElementById('spRefreshToken').value,
                site_id: document.getElementById('spSiteId').value,
                connection_name: '',
            };
            
            await createSharePointConnection(connectionData);
        });

        document.getElementById('sharepointPipelineForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const ingestionType = document.getElementById('spIngestionType').value;
            const driveNames = document.getElementById('spDriveNames').value;
            
            const pipelineData = {
                id: document.getElementById('spPipelineId').value,
                name: document.getElementById('spPipelineName').value,
                connection_id: document.getElementById('spConnectionSelect').value,
                ingestion_type: ingestionType,
                drive_names: ingestionType === 'specific_drives' && driveNames ? 
                    driveNames.split(',').map(d => d.trim()) : null,
                lakebase_table: document.getElementById('spLakebaseTable').value,
                file_pattern: document.getElementById('spFilePattern').value || '*.xlsx',
            };
            
            await createSharePointPipeline(pipelineData);
        });

        document.getElementById('excelStreamForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const configData = {
                id: document.getElementById('esConfigId').value,
                name: document.getElementById('esConfigName').value,
                lakebase_table: document.getElementById('esLakebaseTable').value,
                file_name_pattern: document.getElementById('esFilePattern').value,
                destination_catalog: document.getElementById('esDestCatalog').value,
                destination_schema: document.getElementById('esDestSchema').value,
                destination_table: document.getElementById('esDestTable').value,
                checkpoint_location: document.getElementById('esCheckpointLocation').value,
                trigger_interval: document.getElementById('esTriggerInterval').value,
                is_active: false,
            };
            
            await createExcelStreamConfig(configData);
        });

        // Show/hide drive names input based on ingestion type
        document.getElementById('spIngestionType').addEventListener('change', (e) => {
            const driveNamesGroup = document.getElementById('spDriveNamesGroup');
            if (e.target.value === 'specific_drives') {
                driveNamesGroup.style.display = 'block';
            } else {
                driveNamesGroup.style.display = 'none';
            }
        });

        // ============================================
        // Initialize
        // ============================================

        document.addEventListener('DOMContentLoaded', () => {
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/5e63e9c0-b95b-4914-9005-a6dcb88fa364',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:878',message:'DOMContentLoaded fired',data:{},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'H3,H5'})}).catch(()=>{});
            // #endregion
            loadSharePointConnections();
            loadSharePointPipelines();
            loadExcelStreamConfigs();
        });
    </script>
</body>
</html>
