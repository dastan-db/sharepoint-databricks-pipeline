<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SharePoint to Databricks Data Pipeline</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
            font-size: 0.9rem;
        }

        input {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-container input {
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .search-container input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
        }

        .btn-danger {
            background: #f56565;
            color: white;
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .config-list {
            margin-top: 20px;
        }

        .config-item {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .config-info {
            flex: 1;
        }

        .config-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .config-details {
            color: #718096;
            font-size: 0.9rem;
        }

        .config-actions {
            display: flex;
            gap: 10px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .alert-error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        .alert-info {
            background: #bee3f8;
            color: #2c5282;
            border: 1px solid #90cdf4;
        }

        .hidden {
            display: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .connections-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .connections-table thead {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .connections-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .connections-table tbody tr {
            border-bottom: 1px solid #dee2e6;
            transition: background-color 0.2s;
        }

        .connections-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .connections-table tbody tr.selected {
            background-color: #e7f3ff;
        }

        .connections-table td {
            padding: 12px;
            font-size: 0.95rem;
        }

        .select-cell {
            text-align: center;
        }

        .select-cell input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .connection-type-badge {
            display: inline-block;
            padding: 4px 8px;
            background-color: #667eea;
            color: white;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Excel Column Selection Styles */
        .spreadsheet-container {
            max-height: 400px;
            overflow: auto;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            margin: 20px 0;
            background: white;
        }

        .spreadsheet {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .spreadsheet td {
            border: 1px solid #e2e8f0;
            padding: 6px 10px;
            white-space: nowrap;
        }

        .row-number {
            background: #f7fafc;
            font-weight: bold;
            text-align: center;
            position: sticky;
            left: 0;
            border-right: 2px solid #cbd5e0;
            min-width: 40px;
        }

        .data-row.header-row {
            background: #4299e1;
            color: white;
            font-weight: bold;
        }

        .data-row.header-row .row-number {
            background: #3182ce;
            color: white;
        }

        .column-checkbox-item {
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            margin: 8px 0;
            background: white;
            transition: background-color 0.2s;
        }

        .column-checkbox-item:hover {
            background: #f7fafc;
        }

        .column-checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            vertical-align: middle;
        }

        .column-checkbox-item label {
            cursor: pointer;
            display: inline;
            user-select: none;
        }

        .type-badge {
            background: #bee3f8;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            margin-left: 8px;
            font-weight: 500;
            color: #2c5282;
        }

        .sample-values {
            color: #718096;
            font-size: 0.85em;
            margin-left: 8px;
            font-style: italic;
        }

        .header-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-selector label {
            margin: 0;
        }

        .header-selector select {
            padding: 8px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 0.95em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä SharePoint to Databricks Data Pipeline</h1>

        <!-- Alert Messages -->
        <div id="alertContainer"></div>

        <!-- SharePoint Connections -->
        <div class="card">
            <h2>SharePoint Connections</h2>
            
            <!-- Info box about connections -->
            <div style="background: #e7f3ff; border-left: 4px solid #667eea; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                <strong>‚ÑπÔ∏è Using Unity Catalog Connections</strong>
                <p style="margin: 8px 0 0 0; font-size: 0.95rem; color: #2c5282;">
                    This app uses SharePoint connections from Unity Catalog. 
                    Select an existing connection below to create Lakeflow jobs. 
                    To create new connections, use the Databricks UI or the form below.
                </p>
            </div>
            
            <!-- Search bar for filtering connections -->
            <div class="search-container" style="margin-bottom: 20px;">
                <input 
                    type="text" 
                    id="connectionSearchInput" 
                    placeholder="üîç Search connections by name, ID, site, or catalog..."
                    style="width: 100%;"
                    autocomplete="off"
                />
            </div>
            
            <!-- Connection list shown below search -->
            <div id="sharepointConnectionList" class="config-list" style="margin-bottom: 20px;">
                <div class="empty-state">
                    <p>Loading SharePoint connections from Unity Catalog...</p>
                </div>
            </div>

            <!-- Toggle button to show/hide the form -->
            <button id="toggleConnectionFormBtn" class="btn btn-secondary" style="margin-bottom: 15px;">
                + Create New Unity Catalog Connection
            </button>

            <!-- Form hidden by default -->
            <form id="sharepointConnectionForm" style="display: none;">
                <div style="background: #fffbeb; border-left: 4px solid #f59e0b; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <strong>‚ö†Ô∏è Advanced Feature</strong>
                    <p style="margin: 8px 0 0 0; font-size: 0.9rem; color: #92400e;">
                        This creates a Unity Catalog SharePoint connection with OAuth User-to-Machine (U2M) credentials.
                        You'll need Azure Entra ID app credentials and an OAuth refresh token.
                    </p>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="spConnectionId">Connection ID *</label>
                        <input type="text" id="spConnectionId" required placeholder="e.g., sharepoint_main">
                        <small style="color: #666; display: block; margin-top: 4px;">
                            Unique identifier for this connection (lowercase, no spaces)
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="spConnectionName">Connection Name *</label>
                        <input type="text" id="spConnectionName" required placeholder="e.g., Main SharePoint">
                        <small style="color: #666; display: block; margin-top: 4px;">
                            Display name for this connection
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="spClientId">Azure Client ID *</label>
                        <input type="text" id="spClientId" required placeholder="Azure Entra ID App Client ID">
                        <small style="color: #666; display: block; margin-top: 4px;">
                            From your Azure Entra ID app registration
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="spClientSecret">Azure Client Secret *</label>
                        <input type="password" id="spClientSecret" required placeholder="Azure App Client Secret">
                        <small style="color: #666; display: block; margin-top: 4px;">
                            Secret value from your Azure app
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="spTenantId">Azure Tenant ID *</label>
                        <input type="text" id="spTenantId" required placeholder="Azure AD Tenant ID">
                        <small style="color: #666; display: block; margin-top: 4px;">
                            Your Microsoft 365 tenant ID
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="spRefreshToken">OAuth Refresh Token *</label>
                        <input type="password" id="spRefreshToken" required placeholder="User OAuth Refresh Token">
                        <small style="color: #666; display: block; margin-top: 4px;">
                            OAuth U2M refresh token for user authentication
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="spSiteId">SharePoint Site ID (Optional)</label>
                        <input type="text" id="spSiteId" placeholder="Site ID for documentation">
                        <small style="color: #666; display: block; margin-top: 4px;">
                            Stored in connection comment for reference
                        </small>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">
                    <span id="createSpConnectionBtnText">Create Unity Catalog Connection</span>
                    <span id="createSpConnectionBtnLoading" class="loading hidden"></span>
                </button>
            </form>
        </div>

        <!-- Lakeflow Job Creation -->
        <div class="card" id="lakeflowJobCard">
            <h2>Lakeflow Jobs - SharePoint to Unity Catalog</h2>
            <p style="color: #666; margin-bottom: 15px; font-size: 0.9rem;">
                Create streaming ingestion jobs that automatically sync all files from SharePoint to Unity Catalog Delta tables
            </p>
            
            <!-- Instruction when no connection selected -->
            <div id="lakeflowJobInstructions" style="padding: 20px; background: #e7f3ff; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                <strong>üëÜ Step 1:</strong> Select a SharePoint connection above to create a new Lakeflow job
            </div>
            
            <!-- Create Job Form -->
            <div id="lakeflowJobFormContainer" style="display: none; margin-bottom: 20px; padding: 20px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #48bb78;">
                <h3 style="margin-top: 0; color: #22543d;">‚úì Connection Selected - Create New Lakeflow Job</h3>
                <p style="color: #666; margin-bottom: 15px; font-size: 0.95rem;">
                    This will create <strong>two pipelines</strong>:
                    <br>1. <strong>Document Table</strong> - Ingests all files from SharePoint with metadata
                    <br>2. <strong>Change Detection</strong> - Tracks file changes and updates target table using CDC
                </p>
                <form id="lakeflowJobForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="lfSiteId">SharePoint Site ID *</label>
                            <input type="text" id="lfSiteId" required placeholder="e.g., 6d152e54-1e19-45d9-a362-af47be1b3ba9">
                            <small style="color: #666; display: block; margin-top: 5px;">
                                The UUID of the SharePoint site to ingest from
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="lfDestCatalog">Destination Catalog *</label>
                            <input type="text" id="lfDestCatalog" required placeholder="e.g., main" value="main">
                        </div>
                        <div class="form-group">
                            <label for="lfDestSchema">Destination Schema *</label>
                            <input type="text" id="lfDestSchema" required placeholder="e.g., hr_documents">
                            <small style="color: #666; display: block; margin-top: 5px;">
                                All SharePoint files will stream into this schema
                            </small>
                        </div>
                    </div>
                    
                    <div style="background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <strong>Selected Connection:</strong> <span id="lfSelectedConnection">None</span><br>
                        <strong>Document Table:</strong> <span id="lfDocTableName">-</span><br>
                        <strong>Target Table:</strong> <span id="lfTargetTableName">-</span>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button type="button" class="btn btn-secondary" onclick="cancelLakeflowJobForm()">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <span id="createLfJobBtnText">Create Job</span>
                            <span id="createLfJobBtnLoading" class="loading hidden"></span>
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Deployment Status Tracker -->
            <div id="deploymentStatusContainer" style="display: none; margin-bottom: 20px; padding: 20px; background: #fffbeb; border-radius: 8px; border-left: 4px solid #f59e0b;">
                <h3 style="margin-top: 0; color: #92400e;">‚öôÔ∏è Deployment in Progress</h3>
                <div style="margin-bottom: 15px;">
                    <strong>Connection:</strong> <span id="deployConnectionName">-</span>
                </div>
                <div style="margin-bottom: 10px;">
                    <div style="display: flex; align-items: center; margin-bottom: 5px;">
                        <span id="docPipelineStatus" style="margin-right: 10px;">‚è≥</span>
                        <strong>Document Ingestion Pipeline:</strong>
                        <span id="docPipelineState" style="margin-left: 10px;">Deploying...</span>
                    </div>
                </div>
                <div id="deploymentProgress" style="background: #fef3c7; border-radius: 4px; height: 8px; overflow: hidden;">
                    <div id="deploymentProgressBar" style="background: #f59e0b; height: 100%; width: 0%; transition: width 0.3s;"></div>
                </div>
                <p id="deploymentMessage" style="margin-top: 10px; font-size: 0.9rem; color: #92400e;">
                    Initializing pipelines...
                </p>
            </div>
            
            <!-- Documents Table Viewer -->
            <div id="documentsViewerContainer" style="display: none; margin-bottom: 20px; padding: 20px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #48bb78;">
                <h3 style="margin-top: 0; color: #22543d;">‚úÖ Deployment Complete - Select Target File</h3>
                <p style="color: #666; margin-bottom: 15px; font-size: 0.95rem;">
                    Select an Excel file from the documents table to configure as your target for CDC updates.
                </p>
                <div style="margin-bottom: 15px;">
                    <strong>Document Table:</strong> <span id="documentsTableName">-</span><br>
                    <strong>Total Documents:</strong> <span id="documentsCount">0</span>
                </div>
                <div style="max-height: 400px; overflow-y: auto; border: 1px solid #d1fae5; border-radius: 8px;">
                    <table class="connections-table" id="documentsTable">
                        <thead>
                            <tr>
                                <th style="width: 50px;">Select</th>
                                <th>File Name</th>
                                <th>Size</th>
                                <th>Last Modified</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="documentsTableBody">
                            <tr><td colspan="5" style="text-align: center; padding: 20px;">Loading documents...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-primary" id="confirmFileSelectionBtn" onclick="confirmFileSelection()" disabled>
                        Confirm Selection
                    </button>
                    <button class="btn btn-secondary" onclick="closeDocumentsViewer()" style="margin-left: 10px; background: #6b7280; color: white;">
                        Close
                    </button>
                </div>
            </div>
            
            <!-- Job List -->
            <div id="lakeflowJobList" class="config-list">
                <div class="empty-state">
                    <p>No Lakeflow jobs yet. Create one above to start streaming data!</p>
                </div>
            </div>
        </div>

        <!-- Lakeflow Pipelines (Excel Ingestion to Delta Tables) -->
        <div class="card">
            <h2>Lakeflow Pipelines - Excel Ingestion to Delta Tables</h2>
            <p style="color: #666; margin-bottom: 15px; font-size: 0.9rem;">Ingest Excel files from SharePoint into Unity Catalog Delta tables</p>
            <form id="sharepointPipelineForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="spPipelineId">Pipeline ID *</label>
                        <input type="text" id="spPipelineId" required placeholder="e.g., hr_excel_ingestion">
                    </div>
                    <div class="form-group">
                        <label for="spPipelineName">Pipeline Name *</label>
                        <input type="text" id="spPipelineName" required placeholder="e.g., HR Excel Ingestion">
                    </div>
                    <div class="form-group">
                        <label for="spConnectionSelect">SharePoint Connection *</label>
                        <select id="spConnectionSelect" required style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                            <option value="">Select a connection...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="spIngestionType">Ingestion Type *</label>
                        <select id="spIngestionType" required style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                            <option value="all_drives">All Drives (entire site)</option>
                            <option value="specific_drives">Specific Drives</option>
                        </select>
                    </div>
                    <div class="form-group" id="spDriveNamesGroup" style="display: none;">
                        <label for="spDriveNames">Drive Names (comma-separated)</label>
                        <input type="text" id="spDriveNames" placeholder="e.g., Documents, Shared Documents">
                    </div>
                    <div class="form-group">
                        <label for="spDeltaTable">Delta Table Name *</label>
                        <input type="text" id="spDeltaTable" required placeholder="e.g., documents" value="documents">
                    </div>
                    <div class="form-group">
                        <label for="spFilePattern">File Pattern</label>
                        <input type="text" id="spFilePattern" placeholder="e.g., *.xlsx" value="*.xlsx">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">
                    <span id="createSpPipelineBtnText">Create Pipeline</span>
                    <span id="createSpPipelineBtnLoading" class="loading hidden"></span>
                </button>
            </form>

            <div id="sharepointPipelineList" class="config-list" style="margin-top: 20px;">
                <div class="empty-state">
                    <p>No Lakeflow pipelines yet. Create one above to get started!</p>
                </div>
            </div>
        </div>

        <!-- Excel Streaming Configurations -->
        <div class="card">
            <h2>Excel Streaming Configurations</h2>
            <p style="color: #666; margin-bottom: 15px; font-size: 0.9rem;">Continuously stream Excel data from Lakebase to Delta tables</p>
            <form id="excelStreamForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="esConfigId">Config ID *</label>
                        <input type="text" id="esConfigId" required placeholder="e.g., hr_stream">
                    </div>
                    <div class="form-group">
                        <label for="esConfigName">Config Name *</label>
                        <input type="text" id="esConfigName" required placeholder="e.g., HR Data Stream">
                    </div>
                    <div class="form-group">
                        <label for="esLakebaseTable">Lakebase Table (Source) *</label>
                        <input type="text" id="esLakebaseTable" required placeholder="e.g., documents" value="documents">
                    </div>
                    <div class="form-group">
                        <label for="esFilePattern">File Name Pattern *</label>
                        <input type="text" id="esFilePattern" required placeholder="e.g., supplier_*.xlsx">
                    </div>
                    <div class="form-group">
                        <label for="esDestCatalog">Destination Catalog *</label>
                        <input type="text" id="esDestCatalog" required placeholder="e.g., main" value="main">
                    </div>
                    <div class="form-group">
                        <label for="esDestSchema">Destination Schema *</label>
                        <input type="text" id="esDestSchema" required placeholder="e.g., analytics">
                    </div>
                    <div class="form-group">
                        <label for="esDestTable">Destination Table *</label>
                        <input type="text" id="esDestTable" required placeholder="e.g., supplier_data">
                    </div>
                    <div class="form-group">
                        <label for="esCheckpointLocation">Checkpoint Location *</label>
                        <input type="text" id="esCheckpointLocation" required placeholder="/checkpoints/supplier_stream">
                    </div>
                    <div class="form-group">
                        <label for="esTriggerInterval">Trigger Interval</label>
                        <select id="esTriggerInterval" style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                            <option value="10 seconds">10 seconds</option>
                            <option value="30 seconds">30 seconds</option>
                            <option value="1 minute">1 minute</option>
                            <option value="5 minutes">5 minutes</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">
                    <span id="createEsBtnText">Create Stream Config</span>
                    <span id="createEsBtnLoading" class="loading hidden"></span>
                </button>
            </form>

            <div id="excelStreamList" class="config-list" style="margin-top: 20px;">
                <div class="empty-state">
                    <p>No Excel streaming configs yet. Create one above to get started!</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // API Communication Functions
        // ============================================
        
        const API_BASE = '';

        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(API_BASE + url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers,
                    },
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.message || 'API request failed');
                }
                return data;
            } catch (error) {
                throw error;
            }
        }

        // ============================================
        // UI Helper Functions
        // ============================================

        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function setLoading(btnTextId, btnLoadingId, isLoading) {
            const text = document.getElementById(btnTextId);
            const loading = document.getElementById(btnLoadingId);
            if (isLoading) {
                text.classList.add('hidden');
                loading.classList.remove('hidden');
            } else {
                text.classList.remove('hidden');
                loading.classList.add('hidden');
            }
        }

        // ============================================
        // SharePoint Connection Management
        // ============================================

        // Store all connections for filtering
        let allConnections = [];
        
        // Store selected connection
        let selectedConnection = null;

        function selectConnection(connectionId, connectionName) {
            selectedConnection = {
                id: connectionId,
                name: connectionName
            };
            
            // Update visual state - highlight selected row
            document.querySelectorAll('.connection-row').forEach(row => {
                row.classList.remove('selected');
            });
            document.querySelector(`[data-connection-id="${connectionId}"]`)?.classList.add('selected');
            
            console.log('Selected connection:', selectedConnection);
            
            // Show confirmation message
            showAlert(`Connection selected: ${connectionName} - Complete the job details below`, 'success');
            
            // Automatically expand the Lakeflow job form
            showLakeflowJobForm();
        }

        // Function to get current selection (for later use)
        function getSelectedConnection() {
            return selectedConnection;
        }

        async function loadSharePointConnections() {
            try {
                const connections = await apiCall('/sharepoint/connections');
                allConnections = connections; // Store globally
                console.log('Loaded connections:', allConnections.length);
                
                renderSharePointConnections(connections);
                populateConnectionDropdown(connections);
                
                // Setup search filter after connections are loaded
                setupSearchFilter();
            } catch (error) {
                console.error('Failed to load SharePoint connections:', error);
                showAlert('Failed to load SharePoint connections: ' + error.message, 'error');
            }
        }
        
        function setupSearchFilter() {
            const searchInput = document.getElementById('connectionSearchInput');
            console.log('Setting up search filter, input element:', searchInput);
            if (searchInput) {
                // Explicitly clear any cached value from browser
                searchInput.value = '';
                
                // Remove existing listener if any
                searchInput.removeEventListener('input', handleSearchInput);
                // Add new listener
                searchInput.addEventListener('input', handleSearchInput);
                console.log('Search event listener attached successfully');
            } else {
                console.error('Search input element not found!');
            }
        }
        
        function handleSearchInput(e) {
            console.log('Search input changed:', e.target.value);
            filterConnections(e.target.value);
        }

        function filterConnections(searchTerm) {
            console.log('filterConnections called with:', searchTerm);
            console.log('allConnections length:', allConnections.length);
            
            if (!searchTerm || searchTerm.trim() === '') {
                // Show all connections if search is empty
                renderSharePointConnections(allConnections);
                return;
            }
            
            const term = searchTerm.toLowerCase();
            const filtered = allConnections.filter(conn => {
                return (
                    conn.name.toLowerCase().includes(term) ||
                    conn.id.toLowerCase().includes(term) ||
                    conn.site_id.toLowerCase().includes(term) ||
                    conn.connection_name.toLowerCase().includes(term) ||
                    conn.tenant_id.toLowerCase().includes(term)
                );
            });
            
            console.log('Filtered results:', filtered.length, 'connections');
            renderSharePointConnections(filtered);
        }

        function renderSharePointConnections(connections) {
            const connectionList = document.getElementById('sharepointConnectionList');
            
            if (!connections || connections.length === 0) {
                const searchInput = document.getElementById('connectionSearchInput');
                const isFiltering = searchInput && searchInput.value.trim() !== '';
                
                connectionList.innerHTML = `
                    <div class="empty-state">
                        <p>${isFiltering ? 'No connections match your search.' : 'No SharePoint connections yet. Click the button below to add one!'}</p>
                    </div>
                `;
                return;
            }

            connectionList.innerHTML = `
                <table class="connections-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;">Select</th>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${connections.map(conn => `
                            <tr class="connection-row" data-connection-id="${conn.id}">
                                <td class="select-cell">
                                    <input 
                                        type="radio" 
                                        name="selectedConnection" 
                                        value="${conn.id}"
                                        onchange="selectConnection('${conn.id}', '${conn.name}')"
                                    />
                                </td>
                                <td><strong>${conn.name}</strong></td>
                                <td><span class="connection-type-badge">SHAREPOINT</span></td>
                                <td>${conn.site_id || conn.comment || ''}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function populateConnectionDropdown(connections) {
            const select = document.getElementById('spConnectionSelect');
            select.innerHTML = '<option value="">Select a connection...</option>' +
                connections.map(conn => `<option value="${conn.id}">${conn.name}</option>`).join('');
        }

        async function createSharePointConnection(connectionData) {
            try {
                setLoading('createSpConnectionBtnText', 'createSpConnectionBtnLoading', true);
                const result = await apiCall('/sharepoint/connections', {
                    method: 'POST',
                    body: JSON.stringify(connectionData),
                });
                showAlert('Unity Catalog SharePoint connection created successfully!', 'success');
                document.getElementById('sharepointConnectionForm').reset();
                await loadSharePointConnections();
                
                // Hide form and reset button after successful creation
                document.getElementById('sharepointConnectionForm').style.display = 'none';
                const btn = document.getElementById('toggleConnectionFormBtn');
                btn.textContent = '+ Create New Unity Catalog Connection';
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-secondary');
            } catch (error) {
                showAlert('Failed to create Unity Catalog connection: ' + error.message, 'error');
            } finally {
                setLoading('createSpConnectionBtnText', 'createSpConnectionBtnLoading', false);
            }
        }

        // ============================================
        // Lakeflow Job Management
        // ============================================

        // Store current deployment tracking
        let deploymentPollingInterval = null;
        let currentDeploymentConnectionId = null;
        let selectedDocumentFile = null;

        function showLakeflowJobForm() {
            if (!selectedConnection) {
                showAlert('Please select a SharePoint connection first', 'error');
                return;
            }
            
            // Populate connection info
            document.getElementById('lfSelectedConnection').textContent = selectedConnection.name;
            
            // Show auto-generated table names
            const docTableName = `${selectedConnection.name}_documents`;
            const targetTableName = `${selectedConnection.name}_target`;
            document.getElementById('lfDocTableName').textContent = docTableName;
            document.getElementById('lfTargetTableName').textContent = targetTableName;
            
            // Hide instructions, show form
            document.getElementById('lakeflowJobInstructions').style.display = 'none';
            document.getElementById('lakeflowJobFormContainer').style.display = 'block';
            
            // Smooth scroll to the Lakeflow Job card with some offset
            setTimeout(() => {
                const lakeflowCard = document.getElementById('lakeflowJobCard');
                if (lakeflowCard) {
                    lakeflowCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    // Add a subtle highlight animation
                    lakeflowCard.style.transition = 'box-shadow 0.3s ease';
                    lakeflowCard.style.boxShadow = '0 0 0 4px rgba(102, 126, 234, 0.3)';
                    setTimeout(() => {
                        lakeflowCard.style.boxShadow = '';
                    }, 2000);
                }
            }, 100);
        }

        function cancelLakeflowJobForm() {
            // Hide form, show instructions
            document.getElementById('lakeflowJobFormContainer').style.display = 'none';
            document.getElementById('lakeflowJobInstructions').style.display = 'block';
            document.getElementById('lakeflowJobForm').reset();
            document.getElementById('lfDestCatalog').value = 'main';
            document.getElementById('lfSiteId').value = '';
            
            // Clear the selected connection
            selectedConnection = null;
            document.querySelectorAll('.connection-row').forEach(row => {
                row.classList.remove('selected');
            });
            document.querySelectorAll('input[name="selectedConnection"]').forEach(radio => {
                radio.checked = false;
            });
        }

        function getConnectionSiteId(connectionId) {
            const conn = allConnections.find(c => c.id === connectionId);
            return conn ? (conn.site_id || '') : '';
        }

        async function loadLakeflowJobs() {
            try {
                const jobs = await apiCall('/api/lakeflow/jobs');
                renderLakeflowJobs(jobs);
            } catch (error) {
                console.error('Failed to load Lakeflow jobs:', error);
            }
        }

        function renderLakeflowJobs(jobs) {
            const jobList = document.getElementById('lakeflowJobList');
            
            if (!jobs || jobs.length === 0) {
                jobList.innerHTML = `
                    <div class="empty-state">
                        <p>No Lakeflow jobs yet. Create one above to start streaming data!</p>
                    </div>
                `;
                return;
            }
            
            jobList.innerHTML = jobs.map(job => {
                const syncStatus = job.sync_enabled 
                    ? `<span style="color: #22543d; background: #c6f6d5; padding: 2px 8px; border-radius: 4px; font-size: 0.8em;">Auto-Sync ON</span>`
                    : `<span style="color: #718096; background: #e2e8f0; padding: 2px 8px; border-radius: 4px; font-size: 0.8em;">Auto-Sync OFF</span>`;
                
                const syncInfo = job.sync_enabled && job.target_table
                    ? `<br>üîÑ Syncing to: ${job.target_table}`
                    : '';
                
                const syncButton = job.sync_enabled
                    ? `<button class="btn btn-success" onclick="runSyncJob('${job.connection_id}')" style="background: #48bb78;">
                            Run Sync
                       </button>`
                    : '';
                
                return `
                <div class="config-item">
                    <div class="config-info">
                        <div class="config-title">
                            ${job.connection_name}
                            ${syncStatus}
                        </div>
                        <div class="config-details">
                            üîó ${job.connection_name} ‚Üí üìä ${job.destination_catalog}.${job.destination_schema}
                        </div>
                        <div style="font-size: 0.85rem; color: #888; margin-top: 5px;">
                            üåê Site ID: ${job.source_schema || 'N/A'}<br>
                            üìÑ Document Table: ${job.document_table || 'N/A'}<br>
                            üîó Pipeline ID: ${job.document_pipeline_id || 'N/A'}${syncInfo}
                        </div>
                    </div>
                    <div class="config-actions">
                        ${syncButton}
                        <button class="btn btn-primary" onclick="loadDocumentsTable('${job.connection_id}')" style="background: #4299e1;">
                            View Documents
                        </button>
                        <button class="btn btn-danger" onclick="deleteLakeflowJob('${job.connection_id}')">
                            Delete
                        </button>
                    </div>
                </div>
            `}).join('');
        }
        
        async function runSyncJob(connectionId) {
            try {
                showAlert('Starting sync job...', 'info');
                const result = await apiCall(`/api/lakeflow/jobs/${connectionId}/run-sync`, {
                    method: 'POST'
                });
                showAlert(`Sync job triggered! Run ID: ${result.run_id}`, 'success');
            } catch (error) {
                showAlert('Failed to run sync job: ' + error.message, 'error');
            }
        }

        async function deleteLakeflowJob(jobId) {
            if (!confirm('Are you sure you want to delete this Lakeflow job?')) {
                return;
            }
            
            try {
                await apiCall(`/api/lakeflow/jobs/${jobId}`, { method: 'DELETE' });
                showAlert('Lakeflow job deleted successfully!', 'success');
                await loadLakeflowJobs();
            } catch (error) {
                showAlert('Failed to delete job: ' + error.message, 'error');
            }
        }

        async function startDeploymentTracking(connectionId, connectionName) {
            // Show deployment status container
            currentDeploymentConnectionId = connectionId;
            document.getElementById('deployConnectionName').textContent = connectionName;
            document.getElementById('deploymentStatusContainer').style.display = 'block';
            document.getElementById('documentsViewerContainer').style.display = 'none';
            
            // Start polling for status
            pollDeploymentStatus();
            deploymentPollingInterval = setInterval(pollDeploymentStatus, 5000); // Poll every 5 seconds
        }

        async function pollDeploymentStatus() {
            if (!currentDeploymentConnectionId) return;
            
            try {
                const status = await apiCall(`/api/lakeflow/jobs/${currentDeploymentConnectionId}/status`);
                
                // Update document pipeline status
                const docState = status.document_pipeline.state;
                const docUpdate = status.document_pipeline.latest_update;
                
                if (docState === 'RUNNING' || (docUpdate && docUpdate.state === 'RUNNING')) {
                    document.getElementById('docPipelineStatus').textContent = 'üîÑ';
                    document.getElementById('docPipelineState').textContent = 'Running...';
                    document.getElementById('deploymentProgressBar').style.width = '50%';
                    document.getElementById('deploymentMessage').textContent = 'Ingesting documents from SharePoint...';
                } else if (docState === 'IDLE' || (docUpdate && docUpdate.state === 'COMPLETED')) {
                    document.getElementById('docPipelineStatus').textContent = '‚úÖ';
                    document.getElementById('docPipelineState').textContent = 'Completed';
                    document.getElementById('deploymentProgressBar').style.width = '100%';
                    document.getElementById('deploymentMessage').textContent = 'Document ingestion complete!';
                    
                    // Stop polling and load documents
                    if (deploymentPollingInterval) {
                        clearInterval(deploymentPollingInterval);
                        deploymentPollingInterval = null;
                    }
                    
                    // Hide deployment status and show documents viewer
                    setTimeout(() => {
                        document.getElementById('deploymentStatusContainer').style.display = 'none';
                        loadDocumentsTable(currentDeploymentConnectionId);
                    }, 2000);
                } else if (docUpdate && docUpdate.state === 'FAILED') {
                    document.getElementById('docPipelineStatus').textContent = '‚ùå';
                    document.getElementById('docPipelineState').textContent = 'Failed';
                    document.getElementById('deploymentMessage').textContent = 'Pipeline failed. Please check Databricks for details.';
                    if (deploymentPollingInterval) {
                        clearInterval(deploymentPollingInterval);
                        deploymentPollingInterval = null;
                    }
                } else {
                    document.getElementById('docPipelineStatus').textContent = '‚è≥';
                    document.getElementById('docPipelineState').textContent = 'Initializing...';
                    document.getElementById('deploymentProgressBar').style.width = '25%';
                }
                
            } catch (error) {
                console.error('Failed to poll deployment status:', error);
                document.getElementById('deploymentMessage').textContent = 'Error checking status: ' + error.message;
            }
        }

        async function loadDocumentsTable(connectionId) {
            try {
                document.getElementById('documentsViewerContainer').style.display = 'block';
                document.getElementById('documentsTableBody').innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">Loading documents...</td></tr>';
                
                const result = await apiCall(`/api/lakeflow/jobs/${connectionId}/documents`);
                
                document.getElementById('documentsTableName').textContent = result.table;
                document.getElementById('documentsCount').textContent = result.count;
                
                if (!result.documents || result.documents.length === 0) {
                    document.getElementById('documentsTableBody').innerHTML = `
                        <tr><td colspan="5" style="text-align: center; padding: 20px; color: #666;">
                            ${result.message || 'No documents found yet. Files may still be ingesting.'}
                        </td></tr>
                    `;
                    return;
                }
                
                // Render documents table
                const tbody = document.getElementById('documentsTableBody');
                tbody.innerHTML = result.documents.map(doc => {
                    const fileName = doc.name || doc.path.split('/').pop();
                    const fileSize = formatFileSize(doc.size);
                    const modTime = doc.modification_time ? new Date(doc.modification_time).toLocaleString() : 'N/A';
                    const isExcel = fileName.toLowerCase().endsWith('.xlsx') || fileName.toLowerCase().endsWith('.xls');
                    
                    return `
                        <tr class="document-row" data-file-path="${doc.path}">
                            <td class="select-cell">
                                <input 
                                    type="radio" 
                                    name="selectedDocument" 
                                    value="${doc.path}"
                                    onchange="selectDocument('${doc.path}', '${fileName}')"
                                />
                            </td>
                            <td><strong>${fileName}</strong></td>
                            <td>${fileSize}</td>
                            <td>${modTime}</td>
                            <td>
                                ${isExcel ? `
                                    <button 
                                        class="btn btn-sm btn-primary" 
                                        onclick="event.stopPropagation(); showExcelPreview('${connectionId}', '${doc.path}')"
                                        style="padding: 5px 10px; font-size: 0.85rem; background: #4299e1;">
                                        üìä Parse Excel
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                }).join('');
                
                // Scroll to documents viewer
                setTimeout(() => {
                    document.getElementById('documentsViewerContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 300);
                
            } catch (error) {
                console.error('Failed to load documents:', error);
                showAlert('Failed to load documents: ' + error.message, 'error');
                document.getElementById('documentsTableBody').innerHTML = `
                    <tr><td colspan="5" style="text-align: center; padding: 20px; color: #e53e3e;">
                        Error loading documents: ${error.message}
                    </td></tr>
                `;
            }
        }

        function selectDocument(filePath, fileName) {
            selectedDocumentFile = { path: filePath, name: fileName };
            document.getElementById('confirmFileSelectionBtn').disabled = false;
            console.log('Selected document:', selectedDocumentFile);
        }

        function confirmFileSelection() {
            if (!selectedDocumentFile) {
                showAlert('Please select a file first', 'error');
                return;
            }
            
            showAlert(`File selected: ${selectedDocumentFile.name}. You can now configure CDC for this file.`, 'success');
            closeDocumentsViewer();
            
            // TODO: Navigate to next step or trigger CDC configuration
            console.log('Confirmed file:', selectedDocumentFile);
        }

        function closeDocumentsViewer() {
            document.getElementById('documentsViewerContainer').style.display = 'none';
            selectedDocumentFile = null;
            document.getElementById('confirmFileSelectionBtn').disabled = true;
            document.querySelectorAll('input[name="selectedDocument"]').forEach(radio => {
                radio.checked = false;
            });
            
            // Reload the jobs list
            loadLakeflowJobs();
        }

        function formatFileSize(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Commented out - no longer used in table view
        // async function testSharePointConnection(connectionId) {
        //     try {
        //         showAlert(`Testing connection ${connectionId}...`, 'info');
        //         const result = await apiCall(`/sharepoint/connections/${connectionId}/test`, {
        //             method: 'POST',
        //         });
        //         
        //         if (result.success) {
        //             showAlert(result.message, 'success');
        //         } else {
        //             showAlert(result.message, 'error');
        //         }
        //     } catch (error) {
        //         showAlert('Failed to test connection: ' + error.message, 'error');
        //     }
        // }

        // async function deleteSharePointConnection(connectionId) {
        //     if (!confirm(`Are you sure you want to delete connection "${connectionId}"?`)) {
        //         return;
        //     }
        //     
        //     try {
        //         await apiCall(`/sharepoint/connections/${connectionId}`, {
        //             method: 'DELETE',
        //         });
        //         showAlert('Connection deleted successfully!', 'success');
        //         await loadSharePointConnections();
        //     } catch (error) {
        //         showAlert('Failed to delete connection: ' + error.message, 'error');
        //     }
        // }

        // ============================================
        // SharePoint Pipeline Management
        // ============================================

        async function loadSharePointPipelines() {
            try {
                const pipelines = await apiCall('/sharepoint/pipelines');
                renderSharePointPipelines(pipelines);
            } catch (error) {
                console.error('Failed to load SharePoint pipelines:', error);
                showAlert('Failed to load SharePoint pipelines: ' + error.message, 'error');
            }
        }

        function renderSharePointPipelines(pipelines) {
            const pipelineList = document.getElementById('sharepointPipelineList');
            
            if (!pipelines || pipelines.length === 0) {
                pipelineList.innerHTML = `
                    <div class="empty-state">
                        <p>No Lakeflow pipelines yet. Create one above to get started!</p>
                    </div>
                `;
                return;
            }

            pipelineList.innerHTML = pipelines.map(pipeline => `
                <div class="config-item">
                    <div class="config-info">
                        <div class="config-title">${pipeline.name}</div>
                        <div class="config-details">
                            üì¶ ${pipeline.ingestion_type === 'all_drives' ? 'All Drives' : 'Specific Drives'} ‚Üí 
                            üìä Delta: ${pipeline.delta_table} (${pipeline.file_pattern || '*.xlsx'})
                        </div>
                    </div>
                    <div class="config-actions">
                        <button class="btn btn-success" onclick="runSharePointPipeline('${pipeline.id}')">
                            Run
                        </button>
                        <button class="btn btn-primary" onclick="getSharePointPipelineStatus('${pipeline.id}')" style="background: #4299e1;">
                            Status
                        </button>
                        <button class="btn btn-danger" onclick="deleteSharePointPipeline('${pipeline.id}')">
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function createSharePointPipeline(pipelineData) {
            try {
                setLoading('createSpPipelineBtnText', 'createSpPipelineBtnLoading', true);
                await apiCall('/sharepoint/pipelines', {
                    method: 'POST',
                    body: JSON.stringify(pipelineData),
                });
                showAlert('Lakeflow pipeline created successfully!', 'success');
                document.getElementById('sharepointPipelineForm').reset();
                document.getElementById('spDeltaTable').value = 'documents';
                document.getElementById('spFilePattern').value = '*.xlsx';
                await loadSharePointPipelines();
            } catch (error) {
                showAlert('Failed to create pipeline: ' + error.message, 'error');
            } finally {
                setLoading('createSpPipelineBtnText', 'createSpPipelineBtnLoading', false);
            }
        }

        async function runSharePointPipeline(pipelineId) {
            try {
                showAlert(`Starting pipeline ${pipelineId}...`, 'info');
                const result = await apiCall(`/sharepoint/pipelines/${pipelineId}/run`, {
                    method: 'POST',
                });
                
                if (result.success) {
                    showAlert(`Pipeline run started! Update ID: ${result.update_id}`, 'success');
                } else {
                    showAlert(result.message, 'error');
                }
            } catch (error) {
                showAlert('Failed to run pipeline: ' + error.message, 'error');
            }
        }

        async function getSharePointPipelineStatus(pipelineId) {
            try {
                const result = await apiCall(`/sharepoint/pipelines/${pipelineId}/status`);
                
                if (result.success) {
                    const statusMsg = `Pipeline State: ${result.state}\n` +
                        (result.latest_update ? 
                            `Latest Update: ${result.latest_update.state || 'N/A'}\n` +
                            `Update ID: ${result.latest_update.update_id || 'N/A'}` 
                            : 'No updates yet');
                    alert(statusMsg);
                } else {
                    showAlert(result.message, 'error');
                }
            } catch (error) {
                showAlert('Failed to get pipeline status: ' + error.message, 'error');
            }
        }

        async function deleteSharePointPipeline(pipelineId) {
            if (!confirm(`Are you sure you want to delete pipeline "${pipelineId}"?`)) {
                return;
            }
            
            try {
                await apiCall(`/sharepoint/pipelines/${pipelineId}`, {
                    method: 'DELETE',
                });
                showAlert('Pipeline deleted successfully!', 'success');
                await loadSharePointPipelines();
            } catch (error) {
                showAlert('Failed to delete pipeline: ' + error.message, 'error');
            }
        }

        // ============================================
        // Excel Streaming Management
        // ============================================

        async function loadExcelStreamConfigs() {
            try {
                const configs = await apiCall('/excel-streaming/configs');
                renderExcelStreamConfigs(configs);
            } catch (error) {
                console.error('Failed to load Excel stream configs:', error);
                showAlert('Failed to load Excel stream configs: ' + error.message, 'error');
            }
        }

        function renderExcelStreamConfigs(configs) {
            const streamList = document.getElementById('excelStreamList');
            
            if (!configs || configs.length === 0) {
                streamList.innerHTML = `
                    <div class="empty-state">
                        <p>No Excel streaming configs yet. Create one above to get started!</p>
                    </div>
                `;
                return;
            }

            streamList.innerHTML = configs.map(config => `
                <div class="config-item">
                    <div class="config-info">
                        <div class="config-title">
                            ${config.is_active ? 'üü¢' : 'üî¥'} ${config.name}
                        </div>
                        <div class="config-details">
                            üìÅ ${config.lakebase_table} (${config.file_name_pattern}) ‚Üí 
                            üìä ${config.destination_catalog}.${config.destination_schema}.${config.destination_table}
                        </div>
                    </div>
                    <div class="config-actions">
                        ${config.is_active ? 
                            `<button class="btn btn-danger" onclick="stopExcelStream('${config.id}')">Stop</button>` :
                            `<button class="btn btn-success" onclick="startExcelStream('${config.id}')">Start</button>`
                        }
                        <button class="btn btn-primary" onclick="getExcelStreamStatus('${config.id}')" style="background: #4299e1;">
                            Status
                        </button>
                        <button class="btn btn-danger" onclick="deleteExcelStreamConfig('${config.id}')">
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function createExcelStreamConfig(configData) {
            try {
                setLoading('createEsBtnText', 'createEsBtnLoading', true);
                await apiCall('/excel-streaming/configs', {
                    method: 'POST',
                    body: JSON.stringify(configData),
                });
                showAlert('Excel stream config created successfully!', 'success');
                document.getElementById('excelStreamForm').reset();
                document.getElementById('esLakebaseTable').value = 'documents';
                document.getElementById('esDestCatalog').value = 'main';
                await loadExcelStreamConfigs();
            } catch (error) {
                showAlert('Failed to create stream config: ' + error.message, 'error');
            } finally {
                setLoading('createEsBtnText', 'createEsBtnLoading', false);
            }
        }

        async function startExcelStream(configId) {
            try {
                showAlert(`Starting stream ${configId}...`, 'info');
                const result = await apiCall(`/excel-streaming/configs/${configId}/start`, {
                    method: 'POST',
                });
                
                if (result.success) {
                    showAlert(`Stream started successfully!`, 'success');
                    await loadExcelStreamConfigs();
                } else {
                    showAlert(result.message, 'error');
                }
            } catch (error) {
                showAlert('Failed to start stream: ' + error.message, 'error');
            }
        }

        async function stopExcelStream(configId) {
            try {
                showAlert(`Stopping stream ${configId}...`, 'info');
                const result = await apiCall(`/excel-streaming/configs/${configId}/stop`, {
                    method: 'POST',
                });
                
                if (result.success) {
                    showAlert(`Stream stopped successfully!`, 'success');
                    await loadExcelStreamConfigs();
                } else {
                    showAlert(result.message, 'error');
                }
            } catch (error) {
                showAlert('Failed to stop stream: ' + error.message, 'error');
            }
        }

        async function getExcelStreamStatus(configId) {
            try {
                const result = await apiCall(`/excel-streaming/configs/${configId}/status`);
                
                if (result.success) {
                    const statusMsg = `Config: ${result.config_name}\n` +
                        `State: ${result.state}\n` +
                        `Active: ${result.is_active ? 'Yes' : 'No'}\n` +
                        `Destination: ${result.destination}`;
                    alert(statusMsg);
                } else {
                    showAlert(result.message, 'error');
                }
            } catch (error) {
                showAlert('Failed to get stream status: ' + error.message, 'error');
            }
        }

        async function deleteExcelStreamConfig(configId) {
            if (!confirm(`Are you sure you want to delete stream config "${configId}"?`)) {
                return;
            }
            
            try {
                await apiCall(`/excel-streaming/configs/${configId}`, {
                    method: 'DELETE',
                });
                showAlert('Stream config deleted successfully!', 'success');
                await loadExcelStreamConfigs();
            } catch (error) {
                showAlert('Failed to delete stream config: ' + error.message, 'error');
            }
        }

        // ============================================
        // Event Handlers
        // ============================================

        // Toggle connection form visibility
        document.getElementById('toggleConnectionFormBtn').addEventListener('click', () => {
            const form = document.getElementById('sharepointConnectionForm');
            const btn = document.getElementById('toggleConnectionFormBtn');
            
            if (form.style.display === 'none') {
                form.style.display = 'block';
                btn.textContent = '‚àí Cancel';
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-danger');
            } else {
                form.style.display = 'none';
                btn.textContent = '+ Create New Unity Catalog Connection';
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-secondary');
            }
        });

        document.getElementById('sharepointConnectionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const connectionData = {
                id: document.getElementById('spConnectionId').value,
                name: document.getElementById('spConnectionName').value,
                client_id: document.getElementById('spClientId').value,
                client_secret: document.getElementById('spClientSecret').value,
                tenant_id: document.getElementById('spTenantId').value,
                refresh_token: document.getElementById('spRefreshToken').value,
                site_id: document.getElementById('spSiteId').value || '',  // Optional
                connection_name: document.getElementById('spConnectionId').value,  // Use ID as connection name
            };
            
            await createSharePointConnection(connectionData);
        });

        document.getElementById('sharepointPipelineForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const ingestionType = document.getElementById('spIngestionType').value;
            const driveNames = document.getElementById('spDriveNames').value;
            
            const pipelineData = {
                id: document.getElementById('spPipelineId').value,
                name: document.getElementById('spPipelineName').value,
                connection_id: document.getElementById('spConnectionSelect').value,
                ingestion_type: ingestionType,
                drive_names: ingestionType === 'specific_drives' && driveNames ? 
                    driveNames.split(',').map(d => d.trim()) : null,
                delta_table: document.getElementById('spDeltaTable').value,
                file_pattern: document.getElementById('spFilePattern').value || '*.xlsx',
            };
            
            await createSharePointPipeline(pipelineData);
        });

        document.getElementById('excelStreamForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const configData = {
                id: document.getElementById('esConfigId').value,
                name: document.getElementById('esConfigName').value,
                lakebase_table: document.getElementById('esLakebaseTable').value,
                file_name_pattern: document.getElementById('esFilePattern').value,
                destination_catalog: document.getElementById('esDestCatalog').value,
                destination_schema: document.getElementById('esDestSchema').value,
                destination_table: document.getElementById('esDestTable').value,
                checkpoint_location: document.getElementById('esCheckpointLocation').value,
                trigger_interval: document.getElementById('esTriggerInterval').value,
                is_active: false,
            };
            
            await createExcelStreamConfig(configData);
        });

        // Show/hide drive names input based on ingestion type
        document.getElementById('spIngestionType').addEventListener('change', (e) => {
            const driveNamesGroup = document.getElementById('spDriveNamesGroup');
            if (e.target.value === 'specific_drives') {
                driveNamesGroup.style.display = 'block';
            } else {
                driveNamesGroup.style.display = 'none';
            }
        });

        // ============================================
        // Initialize
        // ============================================

        document.addEventListener('DOMContentLoaded', () => {
            loadSharePointConnections();
            loadSharePointPipelines();
            loadExcelStreamConfigs();
            loadLakeflowJobs();
            // Search filter setup moved to loadSharePointConnections()
            
            // Handle Lakeflow job form submission
            const lakeflowJobForm = document.getElementById('lakeflowJobForm');
            if (lakeflowJobForm) {
                lakeflowJobForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    if (!selectedConnection) {
                        showAlert('Please select a connection first', 'error');
                        return;
                    }
                    
                    setLoading('createLfJobBtnText', 'createLfJobBtnLoading', true);
                    
                    try {
                        const jobData = {
                            connection_id: selectedConnection.id,
                            connection_name: selectedConnection.name,
                            source_schema: document.getElementById('lfSiteId').value.trim(),
                            destination_catalog: document.getElementById('lfDestCatalog').value,
                            destination_schema: document.getElementById('lfDestSchema').value,
                        };
                        
                        const result = await apiCall('/api/lakeflow/jobs', {
                            method: 'POST',
                            body: JSON.stringify(jobData),
                        });
                        
                        showAlert('Lakeflow job created! Pipelines are being deployed...', 'success');
                        
                        // Save connection name BEFORE clearing the form (which nulls selectedConnection)
                        const connectionNameForTracking = selectedConnection.name;
                        
                        cancelLakeflowJobForm();
                        await loadLakeflowJobs();
                        
                        // Start deployment tracking using saved connection name
                        startDeploymentTracking(result.connection_id, connectionNameForTracking);
                        
                    } catch (error) {
                        showAlert('Failed to create job: ' + error.message, 'error');
                    } finally {
                        setLoading('createLfJobBtnText', 'createLfJobBtnLoading', false);
                    }
                });
            }
        });

        // ========== Excel Preview and Parsing Functions ==========
        
        let currentExcelPreview = null;

        async function showExcelPreview(connectionId, filePath) {
            const modal = document.getElementById('excelPreviewModal');
            const loading = document.getElementById('previewLoading');
            const content = document.getElementById('previewContent');
            
            modal.style.display = 'flex';
            loading.style.display = 'block';
            content.style.display = 'none';
            
            try {
                // Fetch preview
                const response = await fetch(
                    `/api/excel/preview?connection_id=${encodeURIComponent(connectionId)}&file_path=${encodeURIComponent(filePath)}`
                );
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to preview Excel');
                }
                
                const preview = await response.json();
                currentExcelPreview = { ...preview, connectionId };
                
                // Display preview
                loading.style.display = 'none';
                content.style.display = 'block';
                
                renderExcelPreview(preview);
            } catch (error) {
                console.error('Failed to preview Excel:', error);
                showAlert('Failed to preview Excel: ' + error.message, 'error');
                modal.style.display = 'none';
            }
        }

        function renderExcelPreview(preview) {
            const html = `
                <h3 style="margin-top: 0; color: #2d3748; border-bottom: 2px solid #4299e1; padding-bottom: 10px;">
                    üìä Excel Preview - Interactive Column Selection
                </h3>
                
                <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="margin: 0; color: #4a5568;"><strong>File:</strong> ${preview.file_path.split('/').pop()}</p>
                    <p style="margin: 5px 0 0 0; color: #4a5568;"><strong>Sheet:</strong> ${preview.selected_sheet}</p>
                    <p style="margin: 5px 0 0 0; color: #4a5568;"><strong>Total Rows:</strong> ${preview.total_rows} | <strong>Columns:</strong> ${preview.column_count}</p>
                </div>
                
                <!-- Header Row Selector -->
                <div class="header-selector" style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
                    <label style="font-weight: 600; color: #856404; display: block; margin-bottom: 8px;">
                        Step 1: Select Header Row (which row contains column names?)
                    </label>
                    <select id="headerRowSelect" style="padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px; margin-right: 10px;">
                        ${Array.from({length: Math.min(10, preview.total_rows)}, (_, i) => 
                            `<option value="${i}">Row ${i + 1}</option>`
                        ).join('')}
                    </select>
                    <button onclick="analyzeWithHeader()" class="btn btn-primary" style="padding: 8px 16px; background: #4299e1; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Detect Columns
                    </button>
                </div>
                
                <!-- Full Spreadsheet Display -->
                <div class="spreadsheet-container">
                    <table class="spreadsheet">
                        <tbody id="spreadsheetBody">
                            ${preview.raw_data.map((row, i) => `
                                <tr class="data-row" data-row-index="${i}">
                                    <td class="row-number">${i + 1}</td>
                                    ${row.map(cell => `<td>${cell !== null && cell !== undefined ? cell : ''}</td>`).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <!-- Column Selection Panel (hidden initially) -->
                <div id="columnSelectionPanel" style="display:none; margin-top: 20px;">
                    <div style="background: #e7f3ff; padding: 15px; border-radius: 6px; border-left: 4px solid #4299e1; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #1e40af;">Step 2: Select Columns to Include</h4>
                        <p style="margin: 0; color: #4a5568; font-size: 0.9em;">Choose which columns should be created in the Delta table</p>
                    </div>
                    <div class="column-actions" style="margin-bottom: 15px;">
                        <button onclick="selectAllColumns()" class="btn" style="padding: 8px 16px; background: #48bb78; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 8px;">
                            Select All
                        </button>
                        <button onclick="deselectAllColumns()" class="btn" style="padding: 8px 16px; background: #f56565; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Deselect All
                        </button>
                    </div>
                    <div id="columnCheckboxes"></div>
                    
                    <!-- Schema Preview -->
                    <div class="schema-preview" style="margin-top: 20px; padding: 15px; background: #f0fdf4; border-radius: 6px; border-left: 4px solid #48bb78;">
                        <h4 style="margin: 0 0 10px 0; color: #065f46;">Schema Preview</h4>
                        <div id="schemaPreviewContent"></div>
                    </div>
                </div>
                
                <!-- Table Name Input -->
                <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #2d3748;">
                        Target Delta Table Name:
                    </label>
                    <input 
                        type="text" 
                        id="parseTableName" 
                        value="${preview.recommended_table_name}"
                        style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 1rem; margin-bottom: 15px;"
                    >
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button 
                            onclick="closeExcelPreview()" 
                            style="padding: 10px 20px; background: #e2e8f0; color: #2d3748; border: none; border-radius: 6px; cursor: pointer;">
                            Cancel
                        </button>
                        <button 
                            onclick="confirmParseWithSelection()" 
                            id="confirmParseBtn"
                            disabled
                            style="padding: 10px 20px; background: #4299e1; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; opacity: 0.5;">
                            Create Delta Table
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('previewContent').innerHTML = html;
        }

        // Store detected columns for column selection
        let detectedColumns = [];
        
        async function analyzeWithHeader() {
            const headerRow = parseInt(document.getElementById('headerRowSelect').value);
            
            try {
                const response = await fetch(
                    `/api/excel/analyze-columns?connection_id=${currentExcelPreview.connectionId}&file_path=${encodeURIComponent(currentExcelPreview.file_path)}&header_row=${headerRow}&sheet_name=${currentExcelPreview.selected_sheet}`
                );
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to analyze columns');
                }
                
                const analysis = await response.json();
                detectedColumns = analysis.columns;
                
                // Highlight header row in spreadsheet
                document.querySelectorAll('.data-row').forEach(row => {
                    row.classList.remove('header-row');
                });
                const headerRowEl = document.querySelector(`[data-row-index="${headerRow}"]`);
                if (headerRowEl) {
                    headerRowEl.classList.add('header-row');
                }
                
                // Display column checkboxes
                displayColumnCheckboxes(analysis.columns);
                
                showAlert(`Found ${analysis.columns.length} columns in row ${headerRow + 1}`, 'success');
                
            } catch (error) {
                console.error('Failed to analyze columns:', error);
                showAlert('Failed to analyze columns: ' + error.message, 'error');
            }
        }
        
        function displayColumnCheckboxes(columns) {
            const container = document.getElementById('columnCheckboxes');
            container.innerHTML = columns.map(col => `
                <div class="column-checkbox-item">
                    <input type="checkbox" 
                           id="col_${col.name.replace(/[^a-zA-Z0-9]/g, '_')}" 
                           value="${col.name}"
                           checked
                           onchange="updateSchemaPreview()">
                    <label for="col_${col.name.replace(/[^a-zA-Z0-9]/g, '_')}" style="margin-left: 8px; cursor: pointer;">
                        <strong>${col.name}</strong>
                        <span class="type-badge">${col.type}</span>
                        ${col.sample_values && col.sample_values.length > 0 ? 
                            `<span class="sample-values">Sample: ${col.sample_values.slice(0, 3).join(', ')}</span>` : 
                            ''}
                    </label>
                </div>
            `).join('');
            
            document.getElementById('columnSelectionPanel').style.display = 'block';
            updateSchemaPreview();
        }
        
        function selectAllColumns() {
            document.querySelectorAll('#columnCheckboxes input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
            updateSchemaPreview();
        }
        
        function deselectAllColumns() {
            document.querySelectorAll('#columnCheckboxes input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            updateSchemaPreview();
        }
        
        function updateSchemaPreview() {
            const selectedColumns = Array.from(
                document.querySelectorAll('#columnCheckboxes input:checked')
            ).map(cb => cb.value);
            
            const selectedColObjs = detectedColumns.filter(col => selectedColumns.includes(col.name));
            
            const previewContent = document.getElementById('schemaPreviewContent');
            if (selectedColumns.length === 0) {
                previewContent.innerHTML = '<p style="color: #dc2626; margin: 0;">‚ö†Ô∏è No columns selected. Please select at least one column.</p>';
                document.getElementById('confirmParseBtn').disabled = true;
                document.getElementById('confirmParseBtn').style.opacity = '0.5';
            } else {
                previewContent.innerHTML = `
                    <p style="margin: 0 0 10px 0;"><strong>Selected Columns:</strong> ${selectedColumns.length}</p>
                    <div style="max-height: 150px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                            <thead>
                                <tr>
                                    <th style="padding: 6px; text-align: left; border-bottom: 1px solid #cbd5e0;">Column</th>
                                    <th style="padding: 6px; text-align: left; border-bottom: 1px solid #cbd5e0;">Type</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${selectedColObjs.map(col => `
                                    <tr>
                                        <td style="padding: 6px; border-bottom: 1px solid #e2e8f0;">${col.name}</td>
                                        <td style="padding: 6px; border-bottom: 1px solid #e2e8f0;"><span class="type-badge">${col.type}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                document.getElementById('confirmParseBtn').disabled = false;
                document.getElementById('confirmParseBtn').style.opacity = '1';
            }
        }
        
        // Store last parse info for auto-sync setup
        let lastParseInfo = null;
        
        async function confirmParseWithSelection() {
            const headerRow = parseInt(document.getElementById('headerRowSelect').value);
            const selectedColumns = Array.from(
                document.querySelectorAll('#columnCheckboxes input:checked')
            ).map(cb => cb.value);
            
            if (selectedColumns.length === 0) {
                showAlert('Please select at least one column', 'error');
                return;
            }
            
            const tableName = document.getElementById('parseTableName').value.trim();
            
            if (!tableName) {
                showAlert('Please enter a table name', 'error');
                return;
            }
            
            if (!currentExcelPreview) {
                showAlert('No preview data available', 'error');
                return;
            }
            
            // Show loading state
            const parseBtn = document.getElementById('confirmParseBtn');
            const originalText = parseBtn.textContent;
            parseBtn.textContent = 'Creating Table...';
            parseBtn.disabled = true;
            
            try {
                const response = await fetch('/api/excel/parse', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        connection_id: currentExcelPreview.connectionId,
                        file_path: currentExcelPreview.file_path,
                        table_name: tableName,
                        sheet_name: currentExcelPreview.selected_sheet,
                        header_row: headerRow,
                        selected_columns: selectedColumns
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to parse Excel');
                }
                
                const result = await response.json();
                
                // Store parse info for auto-sync setup
                lastParseInfo = {
                    connectionId: currentExcelPreview.connectionId,
                    filePath: currentExcelPreview.file_path,
                    tableName: tableName,
                    headerRow: headerRow,
                    selectedColumns: selectedColumns,
                    result: result
                };
                
                // Show success with auto-sync option
                showAutoSyncOption(result, tableName, selectedColumns.length);
                
                console.log('Parse result:', result);
                
            } catch (error) {
                console.error('Failed to parse Excel:', error);
                showAlert('Failed to parse Excel: ' + error.message, 'error');
                parseBtn.textContent = originalText;
                parseBtn.disabled = false;
            }
        }
        
        // Keep old function for backward compatibility (if needed)
        async function confirmParse() {
            // Redirect to new function
            await confirmParseWithSelection();
        }
        
        function showAutoSyncOption(result, tableName, columnCount) {
            // Update the preview content to show success and auto-sync option
            const content = document.getElementById('previewContent');
            content.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 64px; margin-bottom: 20px;">‚úÖ</div>
                    <h3 style="color: #22543d; margin-bottom: 15px;">Table Created Successfully!</h3>
                    <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; margin-bottom: 25px; text-align: left;">
                        <p style="margin: 0 0 8px 0;"><strong>Table:</strong> ${result.table_name}</p>
                        <p style="margin: 0 0 8px 0;"><strong>Columns:</strong> ${columnCount}</p>
                        <p style="margin: 0;"><strong>Rows Inserted:</strong> ${result.rows_inserted} of ${result.total_rows}</p>
                    </div>
                    
                    <div style="background: #fffbeb; padding: 20px; border-radius: 8px; border-left: 4px solid #f59e0b; margin-bottom: 25px; text-align: left;">
                        <h4 style="margin: 0 0 10px 0; color: #92400e;">Enable Auto-Sync?</h4>
                        <p style="margin: 0 0 15px 0; color: #78350f; font-size: 0.95em;">
                            Would you like to automatically sync this Delta table when the Excel file changes in SharePoint?
                            <br><br>
                            This will run the sync task as a downstream job after each SharePoint ingestion.
                        </p>
                        <div style="display: flex; gap: 10px; justify-content: flex-start;">
                            <button 
                                onclick="enableAutoSync()"
                                class="btn btn-primary"
                                style="padding: 10px 20px; background: #48bb78; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                Enable Auto-Sync
                            </button>
                            <button 
                                onclick="closeExcelPreview(); loadLakeflowJobs();"
                                style="padding: 10px 20px; background: #e2e8f0; color: #2d3748; border: none; border-radius: 6px; cursor: pointer;">
                                Skip for Now
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function enableAutoSync() {
            console.log('[DEBUG] enableAutoSync called, lastParseInfo:', lastParseInfo);
            
            if (!lastParseInfo) {
                console.error('[DEBUG] No lastParseInfo available!');
                showAlert('No parse information available', 'error');
                return;
            }
            
            try {
                const requestBody = {
                    file_path: lastParseInfo.filePath,
                    table_name: lastParseInfo.tableName,
                    header_row: lastParseInfo.headerRow,
                    selected_columns: lastParseInfo.selectedColumns
                };
                console.log('[DEBUG] Sending configure-sync request:', requestBody);
                
                const response = await fetch(`/api/lakeflow/jobs/${lastParseInfo.connectionId}/configure-sync`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestBody)
                });
                
                console.log('[DEBUG] Response status:', response.status);
                
                if (!response.ok) {
                    const error = await response.json();
                    console.error('[DEBUG] Error response:', error);
                    throw new Error(error.detail || 'Failed to configure auto-sync');
                }
                
                const result = await response.json();
                console.log('[DEBUG] Success response:', result);
                
                showAlert(`Auto-sync enabled! The table will update when the Excel file changes in SharePoint.`, 'success');
                
                closeExcelPreview();
                await loadLakeflowJobs();
                
                console.log('Auto-sync configured:', result);
                
            } catch (error) {
                console.error('Failed to enable auto-sync:', error);
                showAlert('Failed to enable auto-sync: ' + error.message, 'error');
            }
        }

        function closeExcelPreview() {
            document.getElementById('excelPreviewModal').style.display = 'none';
            currentExcelPreview = null;
            lastParseInfo = null;
        }
    </script>
    
    <!-- Excel Preview Modal -->
    <div id="excelPreviewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); position: relative; padding: 30px;">
            <button 
                onclick="closeExcelPreview()" 
                style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 28px; color: #a0aec0; cursor: pointer; line-height: 1; padding: 0; width: 30px; height: 30px;"
                title="Close">
                √ó
            </button>
            
            <div id="previewLoading" style="text-align: center; padding: 40px;">
                <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #4299e1; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                <p style="color: #666; font-size: 1.1rem;">Loading Excel preview...</p>
            </div>
            
            <div id="previewContent" style="display: none;">
                <!-- Content will be rendered here -->
            </div>
        </div>
    </div>
    
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .preview-section h4 {
            margin-bottom: 12px;
            font-size: 1.1rem;
        }
        
        .btn-sm {
            font-size: 0.875rem !important;
            padding: 6px 12px !important;
        }
    </style>

</body>
</html>
