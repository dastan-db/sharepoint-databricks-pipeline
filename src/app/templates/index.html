<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SharePoint to Databricks Data Pipeline</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
            font-size: 0.9rem;
        }

        input {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-container input {
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .search-container input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
        }

        .btn-danger {
            background: #f56565;
            color: white;
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .config-list {
            margin-top: 20px;
        }

        .config-item {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .config-info {
            flex: 1;
        }

        .config-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .config-details {
            color: #718096;
            font-size: 0.9rem;
        }

        .config-actions {
            display: flex;
            gap: 10px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .alert-error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        .alert-info {
            background: #bee3f8;
            color: #2c5282;
            border: 1px solid #90cdf4;
        }

        .hidden {
            display: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .connections-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .connections-table thead {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .connections-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .connections-table tbody tr {
            border-bottom: 1px solid #dee2e6;
            transition: background-color 0.2s;
        }

        .connections-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .connections-table tbody tr.selected {
            background-color: #e7f3ff;
        }

        .connections-table td {
            padding: 12px;
            font-size: 0.95rem;
        }

        .select-cell {
            text-align: center;
        }

        .select-cell input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .connection-type-badge {
            display: inline-block;
            padding: 4px 8px;
            background-color: #667eea;
            color: white;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä SharePoint to Databricks Data Pipeline</h1>

        <!-- Alert Messages -->
        <div id="alertContainer"></div>

        <!-- SharePoint Connections -->
        <div class="card">
            <h2>SharePoint Connections</h2>
            
            <!-- Search bar for filtering connections -->
            <div class="search-container" style="margin-bottom: 20px;">
                <input 
                    type="text" 
                    id="connectionSearchInput" 
                    placeholder="üîç Search connections by name, ID, site, or catalog..."
                    style="width: 100%;"
                />
            </div>
            
            <!-- Connection list shown below search -->
            <div id="sharepointConnectionList" class="config-list" style="margin-bottom: 20px;">
                <div class="empty-state">
                    <p>No SharePoint connections yet. Click the button below to add one!</p>
                </div>
            </div>

            <!-- Use Connection button - appears after selection -->
            <div id="useConnectionBtnContainer" style="display: none; margin-top: 15px; text-align: right;">
                <button id="useConnectionBtn" class="btn btn-primary" onclick="showFilePickerModal()">
                    Use Connection
                </button>
            </div>

            <!-- Toggle button to show/hide the form -->
            <button id="toggleConnectionFormBtn" class="btn btn-secondary" style="margin-bottom: 15px;">
                + Add New Connection
            </button>

            <!-- Form hidden by default -->
            <form id="sharepointConnectionForm" style="display: none;">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="spConnectionId">Connection ID *</label>
                        <input type="text" id="spConnectionId" required placeholder="e.g., sharepoint_main">
                    </div>
                    <div class="form-group">
                        <label for="spConnectionName">Connection Name *</label>
                        <input type="text" id="spConnectionName" required placeholder="e.g., Main SharePoint">
                    </div>
                    <div class="form-group">
                        <label for="spClientId">Client ID *</label>
                        <input type="text" id="spClientId" required placeholder="Azure Entra ID Client ID">
                    </div>
                    <div class="form-group">
                        <label for="spClientSecret">Client Secret *</label>
                        <input type="password" id="spClientSecret" required placeholder="Azure Client Secret">
                    </div>
                    <div class="form-group">
                        <label for="spTenantId">Tenant ID *</label>
                        <input type="text" id="spTenantId" required placeholder="Azure Tenant ID">
                    </div>
                    <div class="form-group">
                        <label for="spRefreshToken">Refresh Token *</label>
                        <input type="password" id="spRefreshToken" required placeholder="OAuth Refresh Token">
                    </div>
                    <div class="form-group">
                        <label for="spSiteId">SharePoint Site ID *</label>
                        <input type="text" id="spSiteId" required placeholder="SharePoint Site ID">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">
                    <span id="createSpConnectionBtnText">Create Connection</span>
                    <span id="createSpConnectionBtnLoading" class="loading hidden"></span>
                </button>
            </form>
        </div>

        <!-- File Picker Modal -->
        <div id="filePickerModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 700px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;">Select Excel File from SharePoint</h3>
                    <button onclick="closeFilePickerModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <strong>Connection:</strong> <span id="modalConnectionName"></span>
                </div>
                
                <form id="filePickerForm">
                    <div class="form-group">
                        <label for="sharePointFileUrl">SharePoint File URL *</label>
                        <input 
                            type="text" 
                            id="sharePointFileUrl" 
                            required 
                            placeholder="https://yourcompany.sharepoint.com/sites/site-name/Documents/file.xlsx"
                            style="font-family: monospace; font-size: 0.9rem;"
                        />
                        <small style="color: #666; display: block; margin-top: 5px;">
                            Enter the full SharePoint URL to your Excel file
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label for="excelSheetName">Sheet Name (optional)</label>
                        <input 
                            type="text" 
                            id="excelSheetName" 
                            placeholder="Sheet1"
                        />
                        <small style="color: #666; display: block; margin-top: 5px;">
                            Leave blank to use the first sheet
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label for="excelDataRange">Data Range (optional)</label>
                        <input 
                            type="text" 
                            id="excelDataRange" 
                            placeholder="A1:Y200"
                        />
                        <small style="color: #666; display: block; margin-top: 5px;">
                            Specify the cell range to read (e.g., A1:Y200)
                        </small>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeFilePickerModal()">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <span id="filePickerBtnText">Select File</span>
                            <span id="filePickerBtnLoading" class="loading hidden"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Lakeflow Job Creation -->
        <div class="card">
            <h2>Lakeflow Jobs - SharePoint to Unity Catalog</h2>
            <p style="color: #666; margin-bottom: 15px; font-size: 0.9rem;">
                Create streaming ingestion jobs that automatically sync all files from SharePoint to Unity Catalog Delta tables
            </p>
            
            <!-- Create Job Form -->
            <div id="lakeflowJobFormContainer" style="display: none; margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                <h3 style="margin-top: 0;">Create New Lakeflow Job</h3>
                <form id="lakeflowJobForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="lfJobId">Job ID *</label>
                            <input type="text" id="lfJobId" required placeholder="e.g., sharepoint_ingestion_hr">
                        </div>
                        <div class="form-group">
                            <label for="lfJobName">Job Name *</label>
                            <input type="text" id="lfJobName" required placeholder="e.g., HR SharePoint Ingestion">
                        </div>
                        <div class="form-group">
                            <label for="lfDestCatalog">Destination Catalog *</label>
                            <input type="text" id="lfDestCatalog" required placeholder="e.g., main" value="main">
                        </div>
                        <div class="form-group">
                            <label for="lfDestSchema">Destination Schema *</label>
                            <input type="text" id="lfDestSchema" required placeholder="e.g., hr_documents">
                            <small style="color: #666; display: block; margin-top: 5px;">
                                All SharePoint files will stream into this schema
                            </small>
                        </div>
                    </div>
                    
                    <div style="background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <strong>Selected Connection:</strong> <span id="lfSelectedConnection">None</span><br>
                        <strong>Site ID:</strong> <span id="lfSelectedSiteId">-</span>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button type="button" class="btn btn-secondary" onclick="cancelLakeflowJobForm()">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <span id="createLfJobBtnText">Create Job</span>
                            <span id="createLfJobBtnLoading" class="loading hidden"></span>
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Create Job Button -->
            <button id="createLakeflowJobBtn" class="btn btn-primary" onclick="showLakeflowJobForm()" style="margin-bottom: 20px;">
                + Create Lakeflow Job
            </button>
            
            <!-- Job List -->
            <div id="lakeflowJobList" class="config-list">
                <div class="empty-state">
                    <p>No Lakeflow jobs yet. Create one above to start streaming data!</p>
                </div>
            </div>
        </div>

        <!-- Lakeflow Pipelines (Excel Ingestion to Delta Tables) -->
        <div class="card">
            <h2>Lakeflow Pipelines - Excel Ingestion to Delta Tables</h2>
            <p style="color: #666; margin-bottom: 15px; font-size: 0.9rem;">Ingest Excel files from SharePoint into Unity Catalog Delta tables</p>
            <form id="sharepointPipelineForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="spPipelineId">Pipeline ID *</label>
                        <input type="text" id="spPipelineId" required placeholder="e.g., hr_excel_ingestion">
                    </div>
                    <div class="form-group">
                        <label for="spPipelineName">Pipeline Name *</label>
                        <input type="text" id="spPipelineName" required placeholder="e.g., HR Excel Ingestion">
                    </div>
                    <div class="form-group">
                        <label for="spConnectionSelect">SharePoint Connection *</label>
                        <select id="spConnectionSelect" required style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                            <option value="">Select a connection...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="spIngestionType">Ingestion Type *</label>
                        <select id="spIngestionType" required style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                            <option value="all_drives">All Drives (entire site)</option>
                            <option value="specific_drives">Specific Drives</option>
                        </select>
                    </div>
                    <div class="form-group" id="spDriveNamesGroup" style="display: none;">
                        <label for="spDriveNames">Drive Names (comma-separated)</label>
                        <input type="text" id="spDriveNames" placeholder="e.g., Documents, Shared Documents">
                    </div>
                    <div class="form-group">
                        <label for="spDeltaTable">Delta Table Name *</label>
                        <input type="text" id="spDeltaTable" required placeholder="e.g., documents" value="documents">
                    </div>
                    <div class="form-group">
                        <label for="spFilePattern">File Pattern</label>
                        <input type="text" id="spFilePattern" placeholder="e.g., *.xlsx" value="*.xlsx">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">
                    <span id="createSpPipelineBtnText">Create Pipeline</span>
                    <span id="createSpPipelineBtnLoading" class="loading hidden"></span>
                </button>
            </form>

            <div id="sharepointPipelineList" class="config-list" style="margin-top: 20px;">
                <div class="empty-state">
                    <p>No Lakeflow pipelines yet. Create one above to get started!</p>
                </div>
            </div>
        </div>

        <!-- Excel Streaming Configurations -->
        <div class="card">
            <h2>Excel Streaming Configurations</h2>
            <p style="color: #666; margin-bottom: 15px; font-size: 0.9rem;">Continuously stream Excel data from Lakebase to Delta tables</p>
            <form id="excelStreamForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="esConfigId">Config ID *</label>
                        <input type="text" id="esConfigId" required placeholder="e.g., hr_stream">
                    </div>
                    <div class="form-group">
                        <label for="esConfigName">Config Name *</label>
                        <input type="text" id="esConfigName" required placeholder="e.g., HR Data Stream">
                    </div>
                    <div class="form-group">
                        <label for="esLakebaseTable">Lakebase Table (Source) *</label>
                        <input type="text" id="esLakebaseTable" required placeholder="e.g., documents" value="documents">
                    </div>
                    <div class="form-group">
                        <label for="esFilePattern">File Name Pattern *</label>
                        <input type="text" id="esFilePattern" required placeholder="e.g., supplier_*.xlsx">
                    </div>
                    <div class="form-group">
                        <label for="esDestCatalog">Destination Catalog *</label>
                        <input type="text" id="esDestCatalog" required placeholder="e.g., main" value="main">
                    </div>
                    <div class="form-group">
                        <label for="esDestSchema">Destination Schema *</label>
                        <input type="text" id="esDestSchema" required placeholder="e.g., analytics">
                    </div>
                    <div class="form-group">
                        <label for="esDestTable">Destination Table *</label>
                        <input type="text" id="esDestTable" required placeholder="e.g., supplier_data">
                    </div>
                    <div class="form-group">
                        <label for="esCheckpointLocation">Checkpoint Location *</label>
                        <input type="text" id="esCheckpointLocation" required placeholder="/checkpoints/supplier_stream">
                    </div>
                    <div class="form-group">
                        <label for="esTriggerInterval">Trigger Interval</label>
                        <select id="esTriggerInterval" style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                            <option value="10 seconds">10 seconds</option>
                            <option value="30 seconds">30 seconds</option>
                            <option value="1 minute">1 minute</option>
                            <option value="5 minutes">5 minutes</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">
                    <span id="createEsBtnText">Create Stream Config</span>
                    <span id="createEsBtnLoading" class="loading hidden"></span>
                </button>
            </form>

            <div id="excelStreamList" class="config-list" style="margin-top: 20px;">
                <div class="empty-state">
                    <p>No Excel streaming configs yet. Create one above to get started!</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // API Communication Functions
        // ============================================
        
        const API_BASE = '';

        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(API_BASE + url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers,
                    },
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.message || 'API request failed');
                }
                return data;
            } catch (error) {
                throw error;
            }
        }

        // ============================================
        // UI Helper Functions
        // ============================================

        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function setLoading(btnTextId, btnLoadingId, isLoading) {
            const text = document.getElementById(btnTextId);
            const loading = document.getElementById(btnLoadingId);
            if (isLoading) {
                text.classList.add('hidden');
                loading.classList.remove('hidden');
            } else {
                text.classList.remove('hidden');
                loading.classList.add('hidden');
            }
        }

        // ============================================
        // SharePoint Connection Management
        // ============================================

        // Store all connections for filtering
        let allConnections = [];
        
        // Store selected connection
        let selectedConnection = null;

        function selectConnection(connectionId, connectionName) {
            selectedConnection = {
                id: connectionId,
                name: connectionName
            };
            
            // Update visual state - highlight selected row
            document.querySelectorAll('.connection-row').forEach(row => {
                row.classList.remove('selected');
            });
            document.querySelector(`[data-connection-id="${connectionId}"]`)?.classList.add('selected');
            
            // Show the Use Connection button
            document.getElementById('useConnectionBtnContainer').style.display = 'block';
            
            console.log('Selected connection:', selectedConnection);
            
            // Show confirmation message
            showAlert(`Selected connection: ${connectionName}`, 'success');
        }

        // Function to get current selection (for later use)
        function getSelectedConnection() {
            return selectedConnection;
        }

        async function loadSharePointConnections() {
            try {
                const connections = await apiCall('/sharepoint/connections');
                allConnections = connections; // Store globally
                console.log('Loaded connections:', allConnections.length);
                
                renderSharePointConnections(connections);
                populateConnectionDropdown(connections);
                
                // Setup search filter after connections are loaded
                setupSearchFilter();
            } catch (error) {
                console.error('Failed to load SharePoint connections:', error);
                showAlert('Failed to load SharePoint connections: ' + error.message, 'error');
            }
        }
        
        function setupSearchFilter() {
            const searchInput = document.getElementById('connectionSearchInput');
            console.log('Setting up search filter, input element:', searchInput);
            if (searchInput) {
                // Remove existing listener if any
                searchInput.removeEventListener('input', handleSearchInput);
                // Add new listener
                searchInput.addEventListener('input', handleSearchInput);
                console.log('Search event listener attached successfully');
            } else {
                console.error('Search input element not found!');
            }
        }
        
        function handleSearchInput(e) {
            console.log('Search input changed:', e.target.value);
            filterConnections(e.target.value);
        }

        function filterConnections(searchTerm) {
            console.log('filterConnections called with:', searchTerm);
            console.log('allConnections length:', allConnections.length);
            
            if (!searchTerm || searchTerm.trim() === '') {
                // Show all connections if search is empty
                renderSharePointConnections(allConnections);
                return;
            }
            
            const term = searchTerm.toLowerCase();
            const filtered = allConnections.filter(conn => {
                return (
                    conn.name.toLowerCase().includes(term) ||
                    conn.id.toLowerCase().includes(term) ||
                    conn.site_id.toLowerCase().includes(term) ||
                    conn.connection_name.toLowerCase().includes(term) ||
                    conn.tenant_id.toLowerCase().includes(term)
                );
            });
            
            console.log('Filtered results:', filtered.length, 'connections');
            renderSharePointConnections(filtered);
        }

        function renderSharePointConnections(connections) {
            const connectionList = document.getElementById('sharepointConnectionList');
            
            if (!connections || connections.length === 0) {
                const searchInput = document.getElementById('connectionSearchInput');
                const isFiltering = searchInput && searchInput.value.trim() !== '';
                
                connectionList.innerHTML = `
                    <div class="empty-state">
                        <p>${isFiltering ? 'No connections match your search.' : 'No SharePoint connections yet. Click the button below to add one!'}</p>
                    </div>
                `;
                return;
            }

            connectionList.innerHTML = `
                <table class="connections-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;">Select</th>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${connections.map(conn => `
                            <tr class="connection-row" data-connection-id="${conn.id}">
                                <td class="select-cell">
                                    <input 
                                        type="radio" 
                                        name="selectedConnection" 
                                        value="${conn.id}"
                                        onchange="selectConnection('${conn.id}', '${conn.name}')"
                                    />
                                </td>
                                <td><strong>${conn.name}</strong></td>
                                <td><span class="connection-type-badge">SHAREPOINT</span></td>
                                <td>${conn.site_id || conn.comment || ''}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function populateConnectionDropdown(connections) {
            const select = document.getElementById('spConnectionSelect');
            select.innerHTML = '<option value="">Select a connection...</option>' +
                connections.map(conn => `<option value="${conn.id}">${conn.name}</option>`).join('');
        }

        async function createSharePointConnection(connectionData) {
            try {
                setLoading('createSpConnectionBtnText', 'createSpConnectionBtnLoading', true);
                await apiCall('/sharepoint/connections', {
                    method: 'POST',
                    body: JSON.stringify(connectionData),
                });
                showAlert('SharePoint connection created successfully!', 'success');
                document.getElementById('sharepointConnectionForm').reset();
                await loadSharePointConnections();
                
                // Hide form and reset button after successful creation
                document.getElementById('sharepointConnectionForm').style.display = 'none';
                const btn = document.getElementById('toggleConnectionFormBtn');
                btn.textContent = '+ Add New Connection';
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-secondary');
            } catch (error) {
                showAlert('Failed to create connection: ' + error.message, 'error');
            } finally {
                setLoading('createSpConnectionBtnText', 'createSpConnectionBtnLoading', false);
            }
        }

        // ============================================
        // File Picker Modal Functions
        // ============================================

        function showFilePickerModal() {
            if (!selectedConnection) {
                showAlert('Please select a connection first', 'error');
                return;
            }
            
            document.getElementById('modalConnectionName').textContent = selectedConnection.name;
            document.getElementById('filePickerModal').style.display = 'flex';
        }

        function closeFilePickerModal() {
            document.getElementById('filePickerModal').style.display = 'none';
            document.getElementById('filePickerForm').reset();
        }

        // ============================================
        // Lakeflow Job Management
        // ============================================

        function showLakeflowJobForm() {
            if (!selectedConnection) {
                showAlert('Please select a SharePoint connection first', 'error');
                return;
            }
            
            // Populate connection info
            document.getElementById('lfSelectedConnection').textContent = selectedConnection.name;
            document.getElementById('lfSelectedSiteId').textContent = getConnectionSiteId(selectedConnection.id);
            
            // Show form, hide button
            document.getElementById('lakeflowJobFormContainer').style.display = 'block';
            document.getElementById('createLakeflowJobBtn').style.display = 'none';
        }

        function cancelLakeflowJobForm() {
            document.getElementById('lakeflowJobFormContainer').style.display = 'none';
            document.getElementById('createLakeflowJobBtn').style.display = 'block';
            document.getElementById('lakeflowJobForm').reset();
            document.getElementById('lfDestCatalog').value = 'main';
        }

        function getConnectionSiteId(connectionId) {
            const conn = allConnections.find(c => c.id === connectionId);
            return conn ? conn.site_id : '-';
        }

        async function loadLakeflowJobs() {
            try {
                const jobs = await apiCall('/api/lakeflow/jobs');
                renderLakeflowJobs(jobs);
            } catch (error) {
                console.error('Failed to load Lakeflow jobs:', error);
            }
        }

        function renderLakeflowJobs(jobs) {
            const jobList = document.getElementById('lakeflowJobList');
            
            if (!jobs || jobs.length === 0) {
                jobList.innerHTML = `
                    <div class="empty-state">
                        <p>No Lakeflow jobs yet. Create one above to start streaming data!</p>
                    </div>
                `;
                return;
            }
            
            jobList.innerHTML = jobs.map(job => `
                <div class="config-item">
                    <div class="config-info">
                        <div class="config-title">${job.name}</div>
                        <div class="config-details">
                            üîó ${job.connection_name} ‚Üí üìä ${job.destination_catalog}.${job.destination_schema}
                        </div>
                        <div style="font-size: 0.85rem; color: #888; margin-top: 5px;">
                            Pipeline ID: ${job.pipeline_id || 'Pending'} | Job ID: ${job.job_id || 'Pending'}
                        </div>
                        <div style="font-size: 0.85rem; color: #666; margin-top: 3px;">
                            ‚è∞ Runs every 15 minutes
                        </div>
                    </div>
                    <div class="config-actions">
                        <button class="btn btn-danger" onclick="deleteLakeflowJob('${job.id}')">
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function deleteLakeflowJob(jobId) {
            if (!confirm('Are you sure you want to delete this Lakeflow job?')) {
                return;
            }
            
            try {
                await apiCall(`/api/lakeflow/jobs/${jobId}`, { method: 'DELETE' });
                showAlert('Lakeflow job deleted successfully!', 'success');
                await loadLakeflowJobs();
            } catch (error) {
                showAlert('Failed to delete job: ' + error.message, 'error');
            }
        }

        // Commented out - no longer used in table view
        // async function testSharePointConnection(connectionId) {
        //     try {
        //         showAlert(`Testing connection ${connectionId}...`, 'info');
        //         const result = await apiCall(`/sharepoint/connections/${connectionId}/test`, {
        //             method: 'POST',
        //         });
        //         
        //         if (result.success) {
        //             showAlert(result.message, 'success');
        //         } else {
        //             showAlert(result.message, 'error');
        //         }
        //     } catch (error) {
        //         showAlert('Failed to test connection: ' + error.message, 'error');
        //     }
        // }

        // async function deleteSharePointConnection(connectionId) {
        //     if (!confirm(`Are you sure you want to delete connection "${connectionId}"?`)) {
        //         return;
        //     }
        //     
        //     try {
        //         await apiCall(`/sharepoint/connections/${connectionId}`, {
        //             method: 'DELETE',
        //         });
        //         showAlert('Connection deleted successfully!', 'success');
        //         await loadSharePointConnections();
        //     } catch (error) {
        //         showAlert('Failed to delete connection: ' + error.message, 'error');
        //     }
        // }

        // ============================================
        // SharePoint Pipeline Management
        // ============================================

        async function loadSharePointPipelines() {
            try {
                const pipelines = await apiCall('/sharepoint/pipelines');
                renderSharePointPipelines(pipelines);
            } catch (error) {
                console.error('Failed to load SharePoint pipelines:', error);
                showAlert('Failed to load SharePoint pipelines: ' + error.message, 'error');
            }
        }

        function renderSharePointPipelines(pipelines) {
            const pipelineList = document.getElementById('sharepointPipelineList');
            
            if (!pipelines || pipelines.length === 0) {
                pipelineList.innerHTML = `
                    <div class="empty-state">
                        <p>No Lakeflow pipelines yet. Create one above to get started!</p>
                    </div>
                `;
                return;
            }

            pipelineList.innerHTML = pipelines.map(pipeline => `
                <div class="config-item">
                    <div class="config-info">
                        <div class="config-title">${pipeline.name}</div>
                        <div class="config-details">
                            üì¶ ${pipeline.ingestion_type === 'all_drives' ? 'All Drives' : 'Specific Drives'} ‚Üí 
                            üìä Delta: ${pipeline.delta_table} (${pipeline.file_pattern || '*.xlsx'})
                        </div>
                    </div>
                    <div class="config-actions">
                        <button class="btn btn-success" onclick="runSharePointPipeline('${pipeline.id}')">
                            Run
                        </button>
                        <button class="btn btn-primary" onclick="getSharePointPipelineStatus('${pipeline.id}')" style="background: #4299e1;">
                            Status
                        </button>
                        <button class="btn btn-danger" onclick="deleteSharePointPipeline('${pipeline.id}')">
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function createSharePointPipeline(pipelineData) {
            try {
                setLoading('createSpPipelineBtnText', 'createSpPipelineBtnLoading', true);
                await apiCall('/sharepoint/pipelines', {
                    method: 'POST',
                    body: JSON.stringify(pipelineData),
                });
                showAlert('Lakeflow pipeline created successfully!', 'success');
                document.getElementById('sharepointPipelineForm').reset();
                document.getElementById('spDeltaTable').value = 'documents';
                document.getElementById('spFilePattern').value = '*.xlsx';
                await loadSharePointPipelines();
            } catch (error) {
                showAlert('Failed to create pipeline: ' + error.message, 'error');
            } finally {
                setLoading('createSpPipelineBtnText', 'createSpPipelineBtnLoading', false);
            }
        }

        async function runSharePointPipeline(pipelineId) {
            try {
                showAlert(`Starting pipeline ${pipelineId}...`, 'info');
                const result = await apiCall(`/sharepoint/pipelines/${pipelineId}/run`, {
                    method: 'POST',
                });
                
                if (result.success) {
                    showAlert(`Pipeline run started! Update ID: ${result.update_id}`, 'success');
                } else {
                    showAlert(result.message, 'error');
                }
            } catch (error) {
                showAlert('Failed to run pipeline: ' + error.message, 'error');
            }
        }

        async function getSharePointPipelineStatus(pipelineId) {
            try {
                const result = await apiCall(`/sharepoint/pipelines/${pipelineId}/status`);
                
                if (result.success) {
                    const statusMsg = `Pipeline State: ${result.state}\n` +
                        (result.latest_update ? 
                            `Latest Update: ${result.latest_update.state || 'N/A'}\n` +
                            `Update ID: ${result.latest_update.update_id || 'N/A'}` 
                            : 'No updates yet');
                    alert(statusMsg);
                } else {
                    showAlert(result.message, 'error');
                }
            } catch (error) {
                showAlert('Failed to get pipeline status: ' + error.message, 'error');
            }
        }

        async function deleteSharePointPipeline(pipelineId) {
            if (!confirm(`Are you sure you want to delete pipeline "${pipelineId}"?`)) {
                return;
            }
            
            try {
                await apiCall(`/sharepoint/pipelines/${pipelineId}`, {
                    method: 'DELETE',
                });
                showAlert('Pipeline deleted successfully!', 'success');
                await loadSharePointPipelines();
            } catch (error) {
                showAlert('Failed to delete pipeline: ' + error.message, 'error');
            }
        }

        // ============================================
        // Excel Streaming Management
        // ============================================

        async function loadExcelStreamConfigs() {
            try {
                const configs = await apiCall('/excel-streaming/configs');
                renderExcelStreamConfigs(configs);
            } catch (error) {
                console.error('Failed to load Excel stream configs:', error);
                showAlert('Failed to load Excel stream configs: ' + error.message, 'error');
            }
        }

        function renderExcelStreamConfigs(configs) {
            const streamList = document.getElementById('excelStreamList');
            
            if (!configs || configs.length === 0) {
                streamList.innerHTML = `
                    <div class="empty-state">
                        <p>No Excel streaming configs yet. Create one above to get started!</p>
                    </div>
                `;
                return;
            }

            streamList.innerHTML = configs.map(config => `
                <div class="config-item">
                    <div class="config-info">
                        <div class="config-title">
                            ${config.is_active ? 'üü¢' : 'üî¥'} ${config.name}
                        </div>
                        <div class="config-details">
                            üìÅ ${config.lakebase_table} (${config.file_name_pattern}) ‚Üí 
                            üìä ${config.destination_catalog}.${config.destination_schema}.${config.destination_table}
                        </div>
                    </div>
                    <div class="config-actions">
                        ${config.is_active ? 
                            `<button class="btn btn-danger" onclick="stopExcelStream('${config.id}')">Stop</button>` :
                            `<button class="btn btn-success" onclick="startExcelStream('${config.id}')">Start</button>`
                        }
                        <button class="btn btn-primary" onclick="getExcelStreamStatus('${config.id}')" style="background: #4299e1;">
                            Status
                        </button>
                        <button class="btn btn-danger" onclick="deleteExcelStreamConfig('${config.id}')">
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function createExcelStreamConfig(configData) {
            try {
                setLoading('createEsBtnText', 'createEsBtnLoading', true);
                await apiCall('/excel-streaming/configs', {
                    method: 'POST',
                    body: JSON.stringify(configData),
                });
                showAlert('Excel stream config created successfully!', 'success');
                document.getElementById('excelStreamForm').reset();
                document.getElementById('esLakebaseTable').value = 'documents';
                document.getElementById('esDestCatalog').value = 'main';
                await loadExcelStreamConfigs();
            } catch (error) {
                showAlert('Failed to create stream config: ' + error.message, 'error');
            } finally {
                setLoading('createEsBtnText', 'createEsBtnLoading', false);
            }
        }

        async function startExcelStream(configId) {
            try {
                showAlert(`Starting stream ${configId}...`, 'info');
                const result = await apiCall(`/excel-streaming/configs/${configId}/start`, {
                    method: 'POST',
                });
                
                if (result.success) {
                    showAlert(`Stream started successfully!`, 'success');
                    await loadExcelStreamConfigs();
                } else {
                    showAlert(result.message, 'error');
                }
            } catch (error) {
                showAlert('Failed to start stream: ' + error.message, 'error');
            }
        }

        async function stopExcelStream(configId) {
            try {
                showAlert(`Stopping stream ${configId}...`, 'info');
                const result = await apiCall(`/excel-streaming/configs/${configId}/stop`, {
                    method: 'POST',
                });
                
                if (result.success) {
                    showAlert(`Stream stopped successfully!`, 'success');
                    await loadExcelStreamConfigs();
                } else {
                    showAlert(result.message, 'error');
                }
            } catch (error) {
                showAlert('Failed to stop stream: ' + error.message, 'error');
            }
        }

        async function getExcelStreamStatus(configId) {
            try {
                const result = await apiCall(`/excel-streaming/configs/${configId}/status`);
                
                if (result.success) {
                    const statusMsg = `Config: ${result.config_name}\n` +
                        `State: ${result.state}\n` +
                        `Active: ${result.is_active ? 'Yes' : 'No'}\n` +
                        `Destination: ${result.destination}`;
                    alert(statusMsg);
                } else {
                    showAlert(result.message, 'error');
                }
            } catch (error) {
                showAlert('Failed to get stream status: ' + error.message, 'error');
            }
        }

        async function deleteExcelStreamConfig(configId) {
            if (!confirm(`Are you sure you want to delete stream config "${configId}"?`)) {
                return;
            }
            
            try {
                await apiCall(`/excel-streaming/configs/${configId}`, {
                    method: 'DELETE',
                });
                showAlert('Stream config deleted successfully!', 'success');
                await loadExcelStreamConfigs();
            } catch (error) {
                showAlert('Failed to delete stream config: ' + error.message, 'error');
            }
        }

        // ============================================
        // Event Handlers
        // ============================================

        // Toggle connection form visibility
        document.getElementById('toggleConnectionFormBtn').addEventListener('click', () => {
            const form = document.getElementById('sharepointConnectionForm');
            const btn = document.getElementById('toggleConnectionFormBtn');
            
            if (form.style.display === 'none') {
                form.style.display = 'block';
                btn.textContent = '‚àí Cancel';
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-danger');
            } else {
                form.style.display = 'none';
                btn.textContent = '+ Add New Connection';
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-secondary');
            }
        });

        document.getElementById('sharepointConnectionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const connectionData = {
                id: document.getElementById('spConnectionId').value,
                name: document.getElementById('spConnectionName').value,
                client_id: document.getElementById('spClientId').value,
                client_secret: document.getElementById('spClientSecret').value,
                tenant_id: document.getElementById('spTenantId').value,
                refresh_token: document.getElementById('spRefreshToken').value,
                site_id: document.getElementById('spSiteId').value,
                connection_name: '',
            };
            
            await createSharePointConnection(connectionData);
        });

        document.getElementById('sharepointPipelineForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const ingestionType = document.getElementById('spIngestionType').value;
            const driveNames = document.getElementById('spDriveNames').value;
            
            const pipelineData = {
                id: document.getElementById('spPipelineId').value,
                name: document.getElementById('spPipelineName').value,
                connection_id: document.getElementById('spConnectionSelect').value,
                ingestion_type: ingestionType,
                drive_names: ingestionType === 'specific_drives' && driveNames ? 
                    driveNames.split(',').map(d => d.trim()) : null,
                delta_table: document.getElementById('spDeltaTable').value,
                file_pattern: document.getElementById('spFilePattern').value || '*.xlsx',
            };
            
            await createSharePointPipeline(pipelineData);
        });

        document.getElementById('excelStreamForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const configData = {
                id: document.getElementById('esConfigId').value,
                name: document.getElementById('esConfigName').value,
                lakebase_table: document.getElementById('esLakebaseTable').value,
                file_name_pattern: document.getElementById('esFilePattern').value,
                destination_catalog: document.getElementById('esDestCatalog').value,
                destination_schema: document.getElementById('esDestSchema').value,
                destination_table: document.getElementById('esDestTable').value,
                checkpoint_location: document.getElementById('esCheckpointLocation').value,
                trigger_interval: document.getElementById('esTriggerInterval').value,
                is_active: false,
            };
            
            await createExcelStreamConfig(configData);
        });

        // Show/hide drive names input based on ingestion type
        document.getElementById('spIngestionType').addEventListener('change', (e) => {
            const driveNamesGroup = document.getElementById('spDriveNamesGroup');
            if (e.target.value === 'specific_drives') {
                driveNamesGroup.style.display = 'block';
            } else {
                driveNamesGroup.style.display = 'none';
            }
        });

        // ============================================
        // Initialize
        // ============================================

        document.addEventListener('DOMContentLoaded', () => {
            loadSharePointConnections();
            loadSharePointPipelines();
            loadExcelStreamConfigs();
            loadLakeflowJobs();
            // Search filter setup moved to loadSharePointConnections()
            
            // Handle file picker form submission
            const filePickerForm = document.getElementById('filePickerForm');
            if (filePickerForm) {
                filePickerForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const fileUrl = document.getElementById('sharePointFileUrl').value;
                    const sheetName = document.getElementById('excelSheetName').value;
                    const dataRange = document.getElementById('excelDataRange').value;
                    
                    // Build the dataAddress option if sheet and/or range provided
                    let dataAddress = '';
                    if (sheetName && dataRange) {
                        dataAddress = `'${sheetName}'!${dataRange}`;
                    } else if (sheetName) {
                        dataAddress = `'${sheetName}'`;
                    }
                    
                    // Store the file selection for use in pipeline creation
                    window.selectedSharePointFile = {
                        connection: selectedConnection,
                        url: fileUrl,
                        sheetName: sheetName,
                        dataRange: dataRange,
                        dataAddress: dataAddress
                    };
                    
                    console.log('Selected file:', window.selectedSharePointFile);
                    
                    // Close modal and show success
                    closeFilePickerModal();
                    showAlert(`File selected: ${fileUrl.split('/').pop()}`, 'success');
                    
                    // Auto-select connection in pipeline form
                    const connectionSelect = document.getElementById('spConnectionSelect');
                    if (connectionSelect) {
                        connectionSelect.value = selectedConnection.id;
                    }
                    
                    // Scroll to the pipeline section
                    const pipelineSection = document.querySelector('h2');
                    if (pipelineSection) {
                        pipelineSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            }
            
            // Handle Lakeflow job form submission
            const lakeflowJobForm = document.getElementById('lakeflowJobForm');
            if (lakeflowJobForm) {
                lakeflowJobForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    if (!selectedConnection) {
                        showAlert('Please select a connection first', 'error');
                        return;
                    }
                    
                    setLoading('createLfJobBtnText', 'createLfJobBtnLoading', true);
                    
                    try {
                        const jobData = {
                            id: document.getElementById('lfJobId').value,
                            name: document.getElementById('lfJobName').value,
                            connection_id: selectedConnection.id,
                            connection_name: selectedConnection.name,
                            source_schema: getConnectionSiteId(selectedConnection.id),
                            destination_catalog: document.getElementById('lfDestCatalog').value,
                            destination_schema: document.getElementById('lfDestSchema').value,
                        };
                        
                        await apiCall('/api/lakeflow/jobs', {
                            method: 'POST',
                            body: JSON.stringify(jobData),
                        });
                        
                        showAlert('Lakeflow job created successfully!', 'success');
                        cancelLakeflowJobForm();
                        await loadLakeflowJobs();
                    } catch (error) {
                        showAlert('Failed to create job: ' + error.message, 'error');
                    } finally {
                        setLoading('createLfJobBtnText', 'createLfJobBtnLoading', false);
                    }
                });
            }
        });
    </script>
</body>
</html>
